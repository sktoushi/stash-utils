<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Repository Issue Randomizer</title>
  <!-- Assumes getSecureRandomNumber() is exported from common/random-utils.js -->
  <script src="common/random-utils.js"></script>
</head>
<body>
<script>
(async () => {
  try {
    // 1️⃣ Load dynamic configuration -------------------------
    const res = await fetch('config/all.json');
    if (!res.ok) throw new Error('Failed to load config');
    const cfg = await res.json();// 2️⃣ Build a flat list of issue URLs --------------------
const repos = cfg.repositories || {};
const issues = [];
for (const [repo, info] of Object.entries(repos)) {
  const start = Number(info.issueStartNumber);
  const end   = Number(info.issueEndNumber);
  const user  = info.username;
  for (let i = start; i <= end; i++) {
    issues.push(`https://github.com/${user}/${repo}/issues/${i}`);
  }
}
if (issues.length === 0) throw new Error('No issues found in config');

const n = issues.length;

// 3️⃣ Choose a weighting formula -------------------------
let formulaParam = 'random'; // default: uniform
const formulas = Array.isArray(cfg.formulas) ? cfg.formulas : [];
if (formulas.length > 0) {
  const idx = Math.floor(getSecureRandomNumber() * formulas.length);
  formulaParam = formulas[idx];
}

// 4️⃣ Generate weights, guaranteeing ergodicity ----------
const weights = new Array(n).fill(1);
const MIN_W   = 0.02; // weight floor → never zero

function applyFloor(val) { return Math.max(val, MIN_W); }

switch (formulaParam) {
  case 'leftLeaning':
    // Older issues (low index) get higher weight
    for (let i = 0; i < n; i++) {
      const noise = 0.5 + getSecureRandomNumber();
      weights[i] = applyFloor((n - i) * noise);
    }
    break;

  case 'rightLeaning1':
    // Newer issues (high index) get higher weight
    for (let i = 0; i < n; i++) {
      const noise = 0.5 + getSecureRandomNumber();
      weights[i] = applyFloor((i + 1) * noise);
    }
    break;

  case 'recent20Percent': {
    const startIdx = Math.floor(n * 0.80);
    for (let i = 0; i < n; i++) {
      weights[i] = applyFloor(i >= startIdx ? 5 : 1);
    }
    break;
  }

  case 'recent5Percent': {
    const startIdx = Math.floor(n * 0.95);
    for (let i = 0; i < n; i++) {
      weights[i] = applyFloor(i >= startIdx ? 20 : 1);
    }
    break;
  }

  default:
    // 'random' or unknown → uniform weights (all 1) with floor ensured
    for (let i = 0; i < n; i++) weights[i] = applyFloor(1);
}

// 5️⃣ Weighted‑random picker -----------------------------
function pickWeighted(arr, w) {
  const total = w.reduce((sum, x) => sum + x, 0);
  let rnd = getSecureRandomNumber() * total;
  for (let i = 0; i < arr.length; i++) {
    if (rnd < w[i]) return arr[i];
    rnd -= w[i];
  }
  // Fallback (should never hit):
  return arr[arr.length - 1];
}

// 6️⃣ Redirect to the chosen issue -----------------------
const chosen = pickWeighted(issues, weights);
location.href = chosen;

} catch (err) { console.error(err); document.body.textContent = Error: ${err.message}; } })(); </script>

</body>
</html>
