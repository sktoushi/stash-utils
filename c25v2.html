<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>c25</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">c25</h1>
    <div id="progressContainer"></div>
    <div id="aggregate" class="alert alert-secondary mt-5" role="alert"></div>
    <div id="xDepletion" class="alert alert-warning mt-3" role="alert"></div>
    <div class="card mt-4">
      <div class="card-body">
        <canvas id="valueChart" height="120"></canvas>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    fetch('config/c25.json')
      .then(r => r.json())
      .then(data => {
        const goal = 4100;
        const container = document.getElementById('progressContainer');
        const labels = [];
        const values = [];
        let positiveTotal = 0;
        let xValue = 0;
        let xTime = 0;
        let aggregateValue = 0;
        let aggregateTime = 0;

        Object.entries(data).forEach(([key, entries]) => {
          let valueSum = 0;
          let timeSum = 0;
          Object.values(entries).forEach(e => {
            valueSum += e.value;
            timeSum += e.time;
          });
          const rate = timeSum ? valueSum / timeSum : 0;
          labels.push(key);
          values.push(valueSum);

          if (key !== 'b1' && key !== 'x') {
            aggregateValue += valueSum;
            aggregateTime += timeSum;
          }
          if (key !== 'x') {
            positiveTotal += valueSum;
          } else {
            xValue = valueSum;
            xTime = timeSum;
          }

          if (key !== 'x') {
            const pct = (valueSum / goal) * 100;
            let note = '';
            if (rate > 0 && valueSum < goal) {
              const days = (goal - valueSum) / rate;
              const targetDate = new Date(Date.now() + days * 86400000);
              note = `At this pace, it would take ${Math.round(days).toLocaleString()} days to reach ${goal} — that's on ${targetDate.toISOString().split('T')[0]}.`;
            }
            const div = document.createElement('div');
            div.className = 'mb-3';
            div.innerHTML = `
              <h5>${key} (${valueSum} / ${goal})</h5>
              <div class="progress">
                <div class="progress-bar ${pct>=100?'bg-success':'bg-info'}" role="progressbar"
                     style="width: ${Math.min(pct, 100).toFixed(2)}%;" aria-valuenow="${pct.toFixed(2)}"
                     aria-valuemin="0" aria-valuemax="100">${pct.toFixed(2)}%</div>
              </div>
              ${note ? `<small class="text-muted">${note}</small>` : ''}
            `;
            container.appendChild(div);
          } else {
            const div = document.createElement('div');
            div.className = 'mb-3';
            div.innerHTML = `
              <h5>${key} (${valueSum})</h5>
              <small class="text-muted">Rate: ${rate.toFixed(2)} per day</small>
            `;
            container.appendChild(div);
          }
        });

        const aggregateRate = aggregateTime ? aggregateValue / aggregateTime : 0;
        const aggregateDays = aggregateRate > 0 ? goal / aggregateRate : Infinity;
        if (aggregateRate > 0) {
          const aggregateDate = new Date(Date.now() + aggregateDays * 86400000);
          document.getElementById('aggregate').textContent =
            `At this combined pace, it would take ${Math.round(aggregateDays).toLocaleString()} days to reach ${goal} — that's on ${aggregateDate.toISOString().split('T')[0]}.`;
        }

        if (xTime > 0 && xValue < 0) {
          const xRate = xValue / xTime;
          const daysDeplete = positiveTotal / -xRate;
          const depleteDate = new Date(Date.now() + daysDeplete * 86400000);
          document.getElementById('xDepletion').textContent =
            `At x's pace, all positive balances would be depleted in ${Math.round(daysDeplete).toLocaleString()} days — that's on ${depleteDate.toISOString().split('T')[0]}.`;
        }

        new Chart(document.getElementById('valueChart'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Current Value',
              data: values,
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true, max: goal }
            }
          }
        });
      });
  </script>
</body>
</html>
