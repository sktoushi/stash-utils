<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Call to Post → Finer Things Bucket</title>
    <style>
      html,body{height:100%;margin:0}
      html{
        /* tiled background will be injected via JS once we have blob URL */
        background-repeat:repeat;
        background-size:auto;
      }
      body{
        display:flex;
        align-items:center;
        justify-content:center;
      }
      #play-btn{
        padding:1rem 2rem;
        font-size:1.25rem;
        border:none;
        border-radius:0.5rem;
        cursor:pointer;
        box-shadow:0 4px 8px rgba(0,0,0,.15);
        background:#fff;
      }
    </style>
  </head>
  <body>
    <script defer>
      const DESTINATION =
        "https://sktoushi.github.io/stash-utils/bucket.html?target=bucket-finer-things-in-life";
      const DB_NAME = "calltopostCache";
      const STORE = "assets";
      const ASSETS = {
        mp3: { key: "calltopostMp3", file: "./calltopost.mp3" },
        gif: { key: "calltopostGif", file: "./calltopost.gif" },
      };

      function openDB(){
        return new Promise((resolve,reject)=>{
          const req=indexedDB.open(DB_NAME,1);
          req.onerror=()=>reject(req.error);
          req.onsuccess=()=>resolve(req.result);
          req.onupgradeneeded=()=>req.result.createObjectStore(STORE);
        });
      }

      function getOrFetch(db,key,filename){
        return new Promise((resolve,reject)=>{
          const tx=db.transaction(STORE,"readwrite");
          const store=tx.objectStore(STORE);
          const g=store.get(key);
          g.onsuccess=async()=>{
            if(g.result){resolve(g.result);return;}
            try{
              const resp=await fetch(filename,{cache:"force-cache"});
              if(!resp.ok)throw new Error(resp.status);
              const blob=await resp.blob();
              store.put(blob,key);
              resolve(blob);
            }catch(e){reject(e);}  
          };
          g.onerror=()=>reject(g.error);
        });
      }

      async function main(){
        try{
          const db=await openDB();
          const [mp3Blob,gifBlob]=await Promise.all([
            getOrFetch(db,ASSETS.mp3.key,ASSETS.mp3.file),
            getOrFetch(db,ASSETS.gif.key,ASSETS.gif.file)
          ]);

          const mp3URL=URL.createObjectURL(mp3Blob);
          const gifURL=URL.createObjectURL(gifBlob);

          // set tiled background on <html>
          document.documentElement.style.backgroundImage=`url(${gifURL})`;

          const audio=new Audio(mp3URL);
          audio.setAttribute("playsinline",""); // iOS
          audio.preload="auto";

          audio.addEventListener("ended",()=>window.location.href=DESTINATION);

          // helper: attempt autoplay muted then unmute
          async function attemptAutoPlay(){
            try{
              audio.muted=true;
              await audio.play();
              audio.muted=false;
              return true;
            }catch(e){return false;}
          }

          const success=await attemptAutoPlay();
          if(!success){
            const btn=document.createElement("button");
            btn.id="play-btn";
            btn.textContent="▶︎ Play sound";
            document.body.appendChild(btn);
            btn.addEventListener("click",async()=>{
              btn.disabled=true;
              try{
                await audio.play();
                btn.textContent="Playing…";
              }catch(e){btn.textContent="Playback failed";}
            });
          }
        }catch(err){
          console.error("CallToPost init failed",err);
          // fallback redirect
          setTimeout(()=>window.location.href=DESTINATION,2000);
        }
      }

      main();
    </script>
  </body>
</html>
