<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>C25 Graph</title>
<script src="common/random-utils.js"></script>
<script src="common/d3.min.js"></script>
<style>
  body {
    margin: 0;
    font-family: Helvetica, sans-serif;
  }
  #pantoneColorDisplay {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: rgba(255,255,255,0.8);
    padding: 5px;
    border-radius: 5px;
    font-weight: bold;
    z-index: 1;
  }
  svg {
    width: 100vw;
    height: 100vh;
  }
</style>
</head>
<body>
<div id="pantoneColorDisplay"></div>
<svg></svg>
<script>
(async function() {
  const pantone = await fetch('pantone-colors.json').then(r => r.json());
  const prev = localStorage.getItem('lastPantoneColor');
  let bg;
  for (let i=0;i<5;i++) {
    const idx = Math.floor(getSecureRandomNumber() * pantone.values.length);
    if (pantone.values[idx] !== prev) {
      bg = pantone.values[idx];
      const disp = document.getElementById('pantoneColorDisplay');
      if (disp) disp.textContent = pantone.names[idx] + ' (' + bg + ')';
      break;
    }
  }
  if (!bg) bg = prev || '#ffffff';
  document.body.style.backgroundColor = bg;
  localStorage.setItem('lastPantoneColor', bg);
  const textColor = getReadableTextColor(bg);
  document.body.style.color = textColor;
  document.getElementById('pantoneColorDisplay').style.color = textColor;

  const config = await fetch('config/c25.json').then(r => r.json());
  const nodesMap = new Map();
  const links = [];
  function getNode(id,type){ if(!nodesMap.has(id)) nodesMap.set(id,{id,type,value:0}); return nodesMap.get(id); }

  for(const [base,dates] of Object.entries(config)){
    const baseNode=getNode(base,'base');
    for(const [ym,val] of Object.entries(dates)){
      baseNode.value += +val;
      const monthNode=getNode(ym,'month');
      monthNode.value += +val;
      links.push({source:base,target:ym,value:+val});
      const yr=ym.substring(0,4);
      const yearNode=getNode(yr,'year');
      yearNode.value += +val;
      links.push({source:ym,target:yr,value:+val});
    }
  }
  const nodes=Array.from(nodesMap.values());
  const maxVal=d3.max(nodes,d=>d.value);
  const rScale=d3.scaleSqrt().domain([0,maxVal]).range([5,30]);
  const cScale=d3.scaleLinear().domain([0,maxVal]).range(['steelblue','red']);
  const svg=d3.select('svg');
  const sim=d3.forceSimulation(nodes)
    .force('link',d3.forceLink(links).id(d=>d.id).distance(80))
    .force('charge',d3.forceManyBody().strength(-100))
    .force('center',d3.forceCenter(window.innerWidth/2,window.innerHeight/2));
  const link=svg.append('g').attr('stroke','#999').attr('stroke-opacity',0.6)
    .selectAll('line').data(links).enter().append('line').attr('stroke-width',1);
  const node=svg.append('g').attr('stroke','#fff').attr('stroke-width',1.5)
    .selectAll('circle').data(nodes).enter().append('circle')
      .attr('r',d=>rScale(d.value))
      .attr('fill',d=>cScale(d.value))
      .call(d3.drag().on('start',dragstarted).on('drag',dragged).on('end',dragended));
  const label=svg.append('g').selectAll('text').data(nodes).enter().append('text')
      .attr('text-anchor','middle').attr('dy','0.35em').style('pointer-events','none')
      .style('font-size','16px').style('fill',textColor).text(d=>d.id);
  sim.on('tick',()=>{
    link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y)
        .attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
    node.attr('cx',d=>d.x).attr('cy',d=>d.y);
    label.attr('x',d=>d.x).attr('y',d=>d.y);
  });
  function dragstarted(event){ if(!event.active) sim.alphaTarget(0.3).restart(); event.subject.fx=event.subject.x; event.subject.fy=event.subject.y; }
  function dragged(event){ event.subject.fx=event.x; event.subject.fy=event.y; }
  function dragended(event){ if(!event.active) sim.alphaTarget(0); event.subject.fx=null; event.subject.fy=null; }

  function getReadableTextColor(hex){
    const r=parseInt(hex.substr(1,2),16), g=parseInt(hex.substr(3,2),16), b=parseInt(hex.substr(5,2),16);
    const lum=(0.299*r+0.587*g+0.114*b)/255;
    return lum>0.6?'#000':'#fff';
  }
})();
</script>
</body>
</html>
