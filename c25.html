<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>C25 Graph</title>
<script src="common/random-utils.js"></script>
<script src="common/d3.min.js"></script>
<style>
  body {
    margin: 0;
    font-family: Helvetica, sans-serif;
  }
  #pantoneColorDisplay {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: rgba(255,255,255,0.8);
    padding: 5px;
    border-radius: 5px;
    font-weight: bold;
    z-index: 1;
  }
  svg {
    width: 100vw;
    height: 100vh;
  }
  #totalDisplay {
    position: absolute;
    top: 10px;
    left: 10px;
    background-color: rgba(255,255,255,0.8);
    padding: 5px;
    border-radius: 5px;
    font-weight: bold;
    z-index: 1;
  }
</style>
</head>
<body>
<div id="pantoneColorDisplay"></div>
<div id="totalDisplay"></div>
<svg></svg>
<script>
(function() {
  const pantone={"names":["ultimate-gray","illuminating","very-peri","viva-magenta","digital-lavender","lava-falls","sundial","tranquil-blue","verdigris","caribbean-sand","pink-charlotte","olive-sprig","after-midnight","sunny-side","espresso-brown","cobalt-lake","sirocco-blue","tropical-teal","glacier-lake","blush-light"],"values":["#939597","#f5df4d","#6667ab","#bb2649","#c3aed6","#cf1124","#c09d5a","#acd8e6","#43b5b0","#f6e0b5","#e38b9b","#70843b","#00303e","#ffe13d","#4b3621","#0047ab","#5c8a8b","#008794","#82a6b1","#f9d5d3"]};
  const config={"b1":{"202501":100,"202412":4000},"sb":{"202507":4},"sk":{"202506":0.5},"w":{"202506":3}};
  const prev = localStorage.getItem('lastPantoneColor');
  let bg;
  for (let i=0;i<5;i++) {
    const idx = Math.floor(getSecureRandomNumber() * pantone.values.length);
    if (pantone.values[idx] !== prev) {
      bg = pantone.values[idx];
      const disp = document.getElementById('pantoneColorDisplay');
      if (disp) disp.textContent = pantone.names[idx] + ' (' + bg + ')';
      break;
    }
  }
  if (!bg) bg = prev || '#ffffff';
  document.body.style.backgroundColor = bg;
  localStorage.setItem('lastPantoneColor', bg);
  const textColor = getReadableTextColor(bg);
  document.body.style.color = textColor;
  document.getElementById('pantoneColorDisplay').style.color = textColor;

  const nodesMap = new Map();
  const links = [];
  function getNode(id,type){ if(!nodesMap.has(id)) nodesMap.set(id,{id,type,value:0}); return nodesMap.get(id); }

  for(const [base,dates] of Object.entries(config)){
    const baseNode=getNode(base,'base');
    for(const [ym,val] of Object.entries(dates)){
      baseNode.value += +val;
      const monthNode=getNode(ym,'month');
      monthNode.value += +val;
      links.push({source:base,target:ym,value:+val});
      const yr=ym.substring(0,4);
      const yearNode=getNode(yr,'year');
      yearNode.value += +val;
      links.push({source:ym,target:yr,value:+val});
    }
  }
  const nodes=Array.from(nodesMap.values());
  const total = nodes.reduce((s,n)=>s+n.value,0);
  document.getElementById('totalDisplay').textContent = 'Total: '+total;
  const maxVal=d3.max(nodes,d=>d.value);
  const rScale=d3.scaleSqrt().domain([0,maxVal]).range([5,30]);
  const cScale=d3.scaleLinear().domain([0,maxVal]).range(['steelblue','red']);
  const svg=d3.select('svg');
  const linkForce = d3.forceLink(links).id(d=>d.id).distance(80);
  const chargeForce = d3.forceManyBody().strength(-100);
  const sim=d3.forceSimulation(nodes)
    .force('link',linkForce)
    .force('charge',chargeForce)
    .force('center',d3.forceCenter(window.innerWidth/2,window.innerHeight/2));
  const link=svg.append('g').attr('stroke','#999').attr('stroke-opacity',0.6)
    .selectAll('line').data(links).enter().append('line').attr('stroke-width',1);
  const node=svg.append('g').attr('stroke','#fff').attr('stroke-width',1.5)
    .selectAll('circle').data(nodes).enter().append('circle')
      .attr('r',d=>rScale(d.value))
      .attr('fill',d=>cScale(d.value))
      .call(d3.drag().on('start',dragstarted).on('drag',dragged).on('end',dragended));
  const label=svg.append('g').selectAll('text').data(nodes).enter().append('text')
      .attr('text-anchor','middle').attr('dy','0.35em').style('pointer-events','none')
      .style('font-size','16px').style('fill',textColor).text(d=>d.id);

  const moods=[
    {name:'calm',distance:120,charge:-20,decay:0.9,alpha:0.1},
    {name:'mild',distance:90,charge:-80,decay:0.7,alpha:0.3},
    {name:'playful',distance:70,charge:-150,decay:0.5,alpha:0.5},
    {name:'wild',distance:40,charge:-300,decay:0.3,alpha:0.8}
  ];
  function applyMood(m){
    linkForce.distance(m.distance);
    chargeForce.strength(m.charge);
    sim.velocityDecay(m.decay);
    sim.alphaTarget(m.alpha).restart();
  }
  setInterval(()=>{
    const m=moods[Math.floor(getSecureRandomNumber()*moods.length)];
    applyMood(m);
  },5000);
  sim.on('tick',()=>{
    link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y)
        .attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
    node.attr('cx',d=>d.x).attr('cy',d=>d.y);
    label.attr('x',d=>d.x).attr('y',d=>d.y);
  });
  function dragstarted(event){ if(!event.active) sim.alphaTarget(0.3).restart(); event.subject.fx=event.subject.x; event.subject.fy=event.subject.y; }
  function dragged(event){ event.subject.fx=event.x; event.subject.fy=event.y; }
  function dragended(event){ if(!event.active) sim.alphaTarget(0); event.subject.fx=null; event.subject.fy=null; }

  function getReadableTextColor(hex){
    const r=parseInt(hex.substr(1,2),16), g=parseInt(hex.substr(3,2),16), b=parseInt(hex.substr(5,2),16);
    const lum=(0.299*r+0.587*g+0.114*b)/255;
    return lum>0.6?'#000':'#fff';
  }
})();
</script>
</body>
</html>
