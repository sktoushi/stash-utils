<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Bucket Generator</title>
  <!-- Bootstrap CSS (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4">PDF Bucket JSON Generator</h1>

    <!-- PDF Upload -->
    <div class="mb-3">
      <label for="pdfFile" class="form-label fw-bold">Upload PDF</label>
      <input
        type="file"
        class="form-control"
        id="pdfFile"
        accept=".pdf"
      />
      <small class="text-muted">
        PDFs must follow the format:
        <code>filename-startIndex-endIndex.pdf</code>
      </small>
    </div>

    <!-- URL Prefix Field -->
    <div class="mb-3">
      <label for="urlPrefix" class="form-label fw-bold">URL Prefix</label>
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          id="urlPrefix"
          value="https://sktoushi.github.io/ref2501/viewer.html?fileName="
          readonly
        />
        <button id="editUrlPrefix" type="button" class="btn btn-secondary">
          Edit
        </button>
        <button id="saveUrlPrefix" type="button" class="btn btn-primary" disabled>
          Save
        </button>
      </div>
    </div>

    <!-- Bucket URL Field -->
    <div class="mb-3">
      <label for="bucketUrl" class="form-label fw-bold">Bucket URL</label>
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          id="bucketUrl"
          value="https://sktoushi.github.io/stash-utils/bucket.html?target=bucket-xxxxxxx"
          readonly
        />
        <button id="editBucketUrl" type="button" class="btn btn-secondary">
          Edit
        </button>
        <button id="saveBucketUrl" type="button" class="btn btn-primary" disabled>
          Save
        </button>
      </div>
    </div>

    <!-- Generate & Action Buttons -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      <button id="generateJSON" type="button" class="btn btn-success">
        Generate Bucket JSON
      </button>
      <button id="copyJSON" type="button" class="btn btn-secondary" disabled>
        Copy JSON
      </button>
      <button id="downloadJSON" type="button" class="btn btn-info" disabled>
        Download JSON
      </button>
    </div>

    <!-- JSON Output -->
    <div class="card">
      <div class="card-header fw-bold">Generated JSON</div>
      <div class="card-body">
        <pre
          id="jsonOutput"
          class="mb-0 bg-light p-2"
          style="white-space: pre-wrap; user-select: text;"
        ></pre>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (CDN) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    // Global variable to store uploaded PDF file name
    let uploadedPdfFileName = "";

    // References to DOM elements
    const pdfFileInput = document.getElementById("pdfFile");
    const urlPrefixInput = document.getElementById("urlPrefix");
    const bucketUrlInput = document.getElementById("bucketUrl");

    const editUrlPrefixBtn = document.getElementById("editUrlPrefix");
    const saveUrlPrefixBtn = document.getElementById("saveUrlPrefix");

    const editBucketUrlBtn = document.getElementById("editBucketUrl");
    const saveBucketUrlBtn = document.getElementById("saveBucketUrl");

    const generateJSONBtn = document.getElementById("generateJSON");
    const copyJSONBtn = document.getElementById("copyJSON");
    const downloadJSONBtn = document.getElementById("downloadJSON");
    const jsonOutput = document.getElementById("jsonOutput");

    let generatedJSON = ""; // Will hold the final JSON string
    let baseNameForDownload = ""; // For naming the downloaded JSON file

    // Handle PDF file selection
    pdfFileInput.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        uploadedPdfFileName = file.name;
      }
    });

    // Toggle read-only for URL Prefix
    editUrlPrefixBtn.addEventListener("click", function () {
      urlPrefixInput.readOnly = false;
      saveUrlPrefixBtn.disabled = false;
      editUrlPrefixBtn.disabled = true;
    });

    saveUrlPrefixBtn.addEventListener("click", function () {
      urlPrefixInput.readOnly = true;
      saveUrlPrefixBtn.disabled = true;
      editUrlPrefixBtn.disabled = false;
    });

    // Toggle read-only for Bucket URL
    editBucketUrlBtn.addEventListener("click", function () {
      bucketUrlInput.readOnly = false;
      saveBucketUrlBtn.disabled = false;
      editBucketUrlBtn.disabled = true;
    });

    saveBucketUrlBtn.addEventListener("click", function () {
      bucketUrlInput.readOnly = true;
      saveBucketUrlBtn.disabled = true;
      editBucketUrlBtn.disabled = false;
    });

    // Generate Bucket JSON
    generateJSONBtn.addEventListener("click", function () {
      // Reset output
      generatedJSON = "";
      jsonOutput.textContent = "";
      copyJSONBtn.disabled = true;
      downloadJSONBtn.disabled = true;

      if (!uploadedPdfFileName) {
        alert("Please upload a PDF file first.");
        return;
      }

      // The PDF is assumed to end in -{startIndex}-{endIndex}.pdf
      // e.g. example-5-10.pdf => startIndex=5, endIndex=10
      const fileNameWithoutExt = uploadedPdfFileName.replace(".pdf", "");
      const parts = fileNameWithoutExt.split("-");
      if (parts.length < 3) {
        alert("Filename must have the format: name-startIndex-endIndex.pdf");
        return;
      }

      // Extract the numeric start and end from the last two parts
      const endIndexStr = parts.pop(); // e.g. "10"
      const startIndexStr = parts.pop(); // e.g. "5"
      // Whatever remains is the base name (e.g. "example")
      const baseName = parts.join("-");
      baseNameForDownload = baseName; // store for the download .json

      const startIndex = parseInt(startIndexStr, 10);
      const endIndex = parseInt(endIndexStr, 10);

      if (isNaN(startIndex) || isNaN(endIndex)) {
        alert("startIndex/endIndex in the filename are not valid numbers.");
        return;
      }

      // We'll keep the entire original file name in the URL
      const pdfFileNameFull = uploadedPdfFileName;

      // Construct the JSON array
      // "integer order in the series" always begins at 1
      const resultArray = [];
      const prefix = urlPrefixInput.value.trim();

      // rowNumber = 1 for the first, 2 for the second, etc.
      let rowNumber = 1;
      for (let i = startIndex; i <= endIndex; i++) {
        const generatedUrl = `${prefix}${pdfFileNameFull}&startIdx=${i}&endIdx=${i}`;
        // e.g. [1, generatedUrl, 1]
        resultArray.push([rowNumber, generatedUrl, 1]);
        rowNumber++;
      }

      const outputObject = {
        initialFiles: resultArray,
      };

      // Convert final structure to string
      generatedJSON = JSON.stringify(outputObject, null, 4);
      // Display JSON in the <pre> block
      jsonOutput.textContent = generatedJSON;

      // Enable copy and download buttons
      copyJSONBtn.disabled = false;
      downloadJSONBtn.disabled = false;
    });

    // Copy JSON to clipboard
    copyJSONBtn.addEventListener("click", function () {
      if (!generatedJSON) return;
      navigator.clipboard.writeText(generatedJSON)
        .then(() => {
          alert("JSON copied to clipboard!");
        })
        .catch(err => {
          console.error("Error copying to clipboard: ", err);
          alert("Failed to copy JSON.");
        });
    });

    // Download JSON as file
    downloadJSONBtn.addEventListener("click", function () {
      if (!generatedJSON) return;
      // Make a blob
      const blob = new Blob([generatedJSON], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      // Construct hidden anchor, trigger download
      const link = document.createElement("a");
      link.href = url;
      // e.g. "bucket-someName.json"
      link.download = "bucket-" + baseNameForDownload + ".json";
      document.body.appendChild(link);
      link.click();
      // Clean up
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
