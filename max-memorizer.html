<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Sentence Reconstruction Game</title>
  <!-- Bootstrap CSS (CDN) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
</head>
<body class="bg-light">

<div class="container my-5">
  <h1 class="text-center mb-4">Sentence Reconstruction</h1>

  <!-- Text Area and Control Buttons (Initial View) -->
  <div id="initialView">
    <div class="mb-3">
      <label for="userInput" class="form-label fw-bold">Enter Your Passage:</label>
      <textarea
        class="form-control"
        id="userInput"
        rows="6"
        placeholder="Type or paste your paragraphs here..."
      ></textarea>
    </div>
    <button id="startBtn" class="btn btn-primary me-2">Start</button>
    <button id="clearBtn" class="btn btn-secondary">Clear All</button>
  </div>

  <!-- Game View (Hidden by Default) -->
  <div id="gameView" class="d-none">
    <p class="fw-bold" id="progressText">Reconstructing your text...</p>
    <div class="mb-3">
      <p id="workInProgress" class="p-3 border" style="min-height: 100px;">
        <!-- This is where the reconstructed text will gradually appear -->
      </p>
    </div>

    <!-- Choice Buttons -->
    <div class="d-flex flex-wrap mb-3" id="choiceButtons">
      <!-- Buttons for the four distinct choices will be dynamically generated here -->
    </div>

    <!-- Informational Feedback -->
    <div class="alert alert-info d-none" id="completionMsg"></div>

    <!-- Game Control Buttons -->
    <button id="restartBtn" class="btn btn-warning me-2">Restart</button>
    <button id="clearBtn2" class="btn btn-secondary">Clear All</button>
  </div>
</div>

<!-- Bootstrap Bundle JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // A cryptographically secure random generator
  /**
   * Returns a cryptographically secure random number between 0 (inclusive) and 1 (exclusive).
   */
  function getSecureRandomNumber() {
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    return array[0] / (0xFFFFFFFF + 1);
  }

  // Grab references to elements
  const initialView = document.getElementById('initialView');
  const gameView = document.getElementById('gameView');
  const startBtn = document.getElementById('startBtn');
  const clearBtn = document.getElementById('clearBtn');
  const userInput = document.getElementById('userInput');

  const progressText = document.getElementById('progressText');
  const workInProgress = document.getElementById('workInProgress');
  const choiceButtons = document.getElementById('choiceButtons');
  const completionMsg = document.getElementById('completionMsg');

  const restartBtn = document.getElementById('restartBtn');
  const clearBtn2 = document.getElementById('clearBtn2');

  // Global variables to hold state
  let originalText = '';
  let wordsArray = [];
  let currentIndex = 0;  // Which word are we expecting next

  // -----------------------
  // HELPER FUNCTIONS
  // -----------------------
  function parseTextIntoWords(text) {
    // This will split the text into tokens that include punctuation
    // We'll match sequences of non-whitespace until we hit a space
    // e.g. "Don't do this, okay?" -> ["Don't", "do", "this,", "okay?"]
    return text.split(/\s+/).filter(w => w.trim() !== '');
  }

  // Use our secure random number generator to shuffle
  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(getSecureRandomNumber() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // Refresh the four distinct choices
  // One of them is the correct next word
  function generateChoices() {
    choiceButtons.innerHTML = '';

    // The correct word
    const correctWord = wordsArray[currentIndex];

    // We need 3 additional random words from the remainder
    let allUnusedWords = wordsArray.filter((w, i) => i !== currentIndex);

    // Shuffle the unused words to get 3 random
    shuffleArray(allUnusedWords);
    let wrongChoices = allUnusedWords.slice(0, 3);

    // Combine correct word + wrong choices
    let fourChoices = [correctWord, ...wrongChoices];
    // Shuffle them again so correct word isn't always first
    shuffleArray(fourChoices);

    // Generate buttons
    fourChoices.forEach(choice => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-dark me-2 mb-2';
      btn.textContent = choice;
      btn.onclick = () => handleChoiceClick(choice);
      choiceButtons.appendChild(btn);
    });
  }

  // When the user clicks on a choice
  function handleChoiceClick(chosenWord) {
    const correctWord = wordsArray[currentIndex];
    if (chosenWord === correctWord) {
      // Correct choice
      currentIndex++;
      // Reveal that word in the workInProgress area
      workInProgress.textContent = wordsArray.slice(0, currentIndex).join(' ');

      if (currentIndex === wordsArray.length) {
        // Completed
        completionMsg.textContent = 'You have successfully reconstructed the text!';
        completionMsg.classList.remove('d-none');
        // Hide or disable the choice buttons
        choiceButtons.innerHTML = '';
      } else {
        // Show next set of choices
        generateChoices();
      }
    } else {
      // Incorrect choice; shuffle the 4 choices again
      generateChoices();
    }
  }

  // -----------------------
  // MAIN BUTTON LOGIC
  // -----------------------

  // Start the game
  startBtn.addEventListener('click', () => {
    originalText = userInput.value.trim();
    if (!originalText) {
      alert('Please enter some text first!');
      return;
    }

    // Hide initial view, show game view
    initialView.classList.add('d-none');
    gameView.classList.remove('d-none');

    // Parse text into words array
    wordsArray = parseTextIntoWords(originalText);

    // Reset everything
    currentIndex = 0;
    workInProgress.textContent = '';
    completionMsg.classList.add('d-none');
    completionMsg.textContent = '';

    // Generate initial 4 choices
    generateChoices();
  });

  // Restart the game (with the same text)
  restartBtn.addEventListener('click', () => {
    if (!originalText) return;

    // Reset game state
    currentIndex = 0;
    workInProgress.textContent = '';
    completionMsg.classList.add('d-none');
    completionMsg.textContent = '';

    // Re-generate choices
    generateChoices();
  });

  // Clear all - reset the entire page to initial state
  function clearAllPage() {
    userInput.value = '';
    originalText = '';
    wordsArray = [];
    currentIndex = 0;
    workInProgress.textContent = '';
    completionMsg.classList.add('d-none');
    completionMsg.textContent = '';
    choiceButtons.innerHTML = '';

    // Show initial, hide game
    initialView.classList.remove('d-none');
    gameView.classList.add('d-none');
  }

  clearBtn.addEventListener('click', clearAllPage);
  clearBtn2.addEventListener('click', clearAllPage);

</script>
</body>
</html>
