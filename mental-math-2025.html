<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Random Math Practice</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Font Awesome for Icons (optional, used for some icons) -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f8f9fa;
      transition: background-color 0.5s ease;
    }
    body.dark-mode {
      background-color: #343a40;
      color: #f8f9fa;
    }
    .container {
      max-width: 900px;
      margin-top: 30px;
    }
    .large-btn {
      width: 100%;
      margin-bottom: 20px;
      font-size: 1.5rem;
      padding: 1rem 2rem;
    }
    .question-area {
      font-size: 2rem;
      margin-top: 1rem;
    }
    .hidden {
      display: none;
    }
    .tip-block {
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 0.25rem;
    }

    /* Additional dark-mode styling */
    body.dark-mode {
      background-color: #343a40;
      color: #f8f9fa;
    }
    .dark-mode .card {
      background-color: #495057;
      color: #f8f9fa;
    }
    .dark-mode .form-control,
    .dark-mode .form-select {
      background-color: #6c757d;
      color: #f8f9fa;
      border: 1px solid #ced4da;
    }
    .dark-mode .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .dark-mode .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
    }
    /* End dark-mode styling */
  </style>
</head>
<body>
  <!-- A small area at top-right to show the Pantone color name & hex -->
  <div
    id="pantoneColorDisplay"
    style="
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ffffffcc;
      padding: 5px;
      border-radius: 5px;
      font-weight: bold;
    "
  >
    <!-- We'll fill this with the chosen pantone name & color code -->
  </div>

  <div class="container">
    <h1 class="text-center">Random Math Practice</h1>

    <!-- Theme Toggle -->
    <div class="text-end mb-3">
      <button class="btn btn-secondary" onclick="toggleDarkMode()" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i> Dark Mode
      </button>
    </div>

    <!-- Intro Section -->
    <div id="intro-section">
      <p>
        This page generates mental math questions based on one URL param
        <code>?minMaxRep=min_max_reps</code>. 
        Example: <code>?minMaxRep=2_10_5</code> means min=2, max=10, reps=5.
      </p>
      <p>
        We do addition, subtraction, multiplication, and integer-only division.
        After you finish, we give you a score and tips for any missed questions.
        Your best scores might land on our top-15 leaderboard!
      </p>
      <button id="startBtn" class="btn btn-primary large-btn">Start</button>
    </div>

    <!-- Question Section -->
    <div id="question-section" class="hidden">
      <div class="question-area text-center">
        <span id="question-text"></span>
      </div>
      <div class="mb-3 text-center">
        <input
          type="number"
          id="answer-input"
          class="form-control form-control-lg mx-auto"
          style="max-width: 300px;"
          placeholder="Your answer"
        />
      </div>
      <div class="text-center">
        <button id="submitBtn" class="btn btn-success large-btn">Submit</button>
        <button id="skipBtn" class="btn btn-warning large-btn">Skip</button>
      </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="hidden">
      <h3 class="text-center">Session Results</h3>
      <p class="text-center">
        <strong>Correct:</strong> <span id="correctCount"></span> /
        <span id="totalCount"></span><br />
        <strong>Accuracy:</strong> <span id="accuracy"></span><br />
        <strong>Time (seconds):</strong> <span id="timeTaken"></span><br />
        <strong>Final Score:</strong> <span id="finalScore"></span>
      </p>

      <!-- Tips for Missed Questions -->
      <div id="tips-section" class="my-4">
        <h5>Tips for Missed Questions</h5>
        <div id="tips-container" class="mt-2">
          <!-- Each missed question's tip goes here -->
        </div>
      </div>

      <!-- Leaderboard -->
      <h4 class="text-center">Leaderboard (Top 15)</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Username</th>
            <th>Score</th>
            <th>Accuracy</th>
            <th>Time (s)</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body"></tbody>
      </table>
      <div class="text-center">
        <button id="restartBtn" class="btn btn-primary large-btn">Restart</button>
      </div>
    </div>
  </div>

  <!-- Congratulatory Modal -->
  <div
    class="modal fade"
    id="congratsModal"
    tabindex="-1"
    aria-labelledby="congratsModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="congratsModalLabel">Congratulations!</h1>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>You made it onto the Top 15 leaderboard! Awesome job!</p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container (optional if you want to use Toasts) -->
  <div
    aria-live="polite"
    aria-atomic="true"
    class="position-relative"
  >
    <div
      id="toastContainer"
      class="position-fixed bottom-0 end-0 p-3"
      style="z-index: 11"
    >
      <!-- Toasts will go here -->
    </div>
  </div>

  <script>
    /****************************************************************
     * 1) Secure RNG
     ****************************************************************/
    function getSecureRandomNumber() {
      const array = new Uint32Array(1);
      window.crypto.getRandomValues(array);
      return array[0] / (0xffffffff + 1);
    }

    /****************************************************************
     * 2) Pantone Colors from pantone-colors.json
     ****************************************************************/
    let pantoneData = null;
    async function loadPantoneColors() {
      if (!pantoneData) {
        const response = await fetch('pantone-colors.json');
        if (!response.ok) {
          throw new Error('Failed to load pantone-colors.json');
        }
        pantoneData = await response.json();
      }
      return pantoneData;
    }

    // Changes background color to a random pantone color
    async function updateBackgroundColor() {
      try {
        const data = await loadPantoneColors();
        if (!data.names || !data.values || data.names.length !== data.values.length) {
          throw new Error('Invalid format: "names" and "values" arrays must match.');
        }
        const idx = Math.floor(getSecureRandomNumber() * data.names.length);
        const chosenName = data.names[idx];
        const chosenValue = data.values[idx];
        document.body.style.backgroundColor = chosenValue;

        // Show the color name & code in upper-right
        const displayEl = document.getElementById('pantoneColorDisplay');
        if (displayEl) {
          displayEl.textContent = `${chosenName} (${chosenValue})`;
        }
      } catch (e) {
        console.error('Error updating background color:', e);
      }
    }

    // Attach background color changes to button clicks
    function attachColorChange(btn) {
      btn.addEventListener('click', async () => {
        await updateBackgroundColor();
      });
    }

    /****************************************************************
     * 3) Parse the URL param: ?minMaxRep= min_max_reps
     ****************************************************************/
    const urlParams = new URLSearchParams(window.location.search);
    let paramVal = urlParams.get('minMaxRep') || '';
    let minVal = 2, maxVal = 10, repsVal = 5;

    if (paramVal) {
      const parts = paramVal.split('_');
      if (parts.length === 3) {
        const pMin = parseInt(parts[0]);
        const pMax = parseInt(parts[1]);
        const pReps = parseInt(parts[2]);
        if (!isNaN(pMin) && !isNaN(pMax) && !isNaN(pReps)) {
          minVal = pMin;
          maxVal = pMax;
          repsVal = pReps;
        }
      }
    }

    // Boundaries
    if (minVal < 2) minVal = 2;
    if (maxVal < 2) maxVal = 2;
    if (minVal > 999) minVal = 999;
    if (maxVal > 999) maxVal = 999;
    if (repsVal < 1) repsVal = 1;
    if (minVal > maxVal) {
      const tmp = minVal;
      minVal = maxVal;
      maxVal = tmp;
    }

    /****************************************************************
     * 4) Generate question set
     ****************************************************************/
    const operations = ['+', '-', '*', '/'];
    function getRandomInt(min, max) {
      const rng = getSecureRandomNumber();
      return Math.floor(rng * (max - min + 1)) + min;
    }

    function generateQuestions() {
      // Evenly distribute operations
      const opsArr = [];
      for (let i = 0; i < repsVal; i++) {
        opsArr.push(operations[i % operations.length]);
      }
      // Shuffle
      for (let i = opsArr.length - 1; i > 0; i--) {
        const j = Math.floor(getSecureRandomNumber() * (i + 1));
        [opsArr[i], opsArr[j]] = [opsArr[j], opsArr[i]];
      }

      // Build the question objects
      return opsArr.map(op => {
        let a, b, text, answer;
        switch (op) {
          case '+':
            a = getRandomInt(minVal, maxVal);
            b = getRandomInt(minVal, maxVal);
            text = `${a} + ${b}`;
            answer = a + b;
            break;
          case '-':
            a = getRandomInt(minVal, maxVal);
            b = getRandomInt(minVal, maxVal);
            if (b > a) [a, b] = [b, a];
            text = `${a} - ${b}`;
            answer = a - b;
            break;
          case '*':
            a = getRandomInt(minVal, maxVal);
            b = getRandomInt(minVal, maxVal);
            text = `${a} * ${b}`;
            answer = a * b;
            break;
          case '/':
            // integer-only
            b = getRandomInt(minVal, maxVal);
            const multiplier = getRandomInt(minVal, maxVal);
            a = b * multiplier;
            text = `${a} / ${b}`;
            answer = a / b;
            break;
        }
        return {
          questionText: text,
          operation: op,
          operandA: a,
          operandB: b,
          correctAnswer: answer
        };
      });
    }

    /****************************************************************
     * 5) Programmatic Canned Tips
     ****************************************************************/
    function getProgrammaticTip(a, b, op) {
      switch (op) {
        case '+': {
          // Example special logic if a or b is near 100
          if (a >= 95 && a <= 99 && b < 10) {
            return `Because ${a} is close to 100, do 100 + ${b} minus how far ${a} was below 100. The sum is ${
              a + b
            }.`;
          }
          return `A quick way to solve ${a} + ${b} is to add them directly or break them into tens and ones. The sum is ${
            a + b
          }.`;
        }
        case '-': {
          if (b === 0) {
            return `Subtracting zero leaves the number unchanged. The result is ${a}.`;
          }
          return `You can think: "How far from ${b} to ${a}?" The difference is ${a - b}.`;
        }
        case '*': {
          // If near 100 trick (like 99*7)
          if ((a === 99 && b < 20) || (b === 99 && a < 20)) {
            return `Near 100 trick: 99 * 7 = 700 - 7 = 693. Similarly, ${a} * ${b} = ${a * b}.`;
          }
          return `Recall multiplication facts or repeated addition. The product is ${a * b}.`;
        }
        case '/': {
          if (b === 1) {
            return `Dividing by 1 yields the same number, so ${a}.`;
          }
          if (a === b) {
            return `When numerator and denominator are equal, result is 1. So it's 1.`;
          }
          return `Count how many times ${b} fits into ${a} without remainder. The result is ${a / b}.`;
        }
        default:
          return `No tip for this operation.`;
      }
    }

    /****************************************************************
     * 6) Session Logic
     ****************************************************************/
    let questions = [];
    let currentIndex = 0;
    let correctCount = 0;
    let missedQuestions = [];
    let startTime = 0;

    function startSession() {
      document.getElementById('intro-section').classList.add('hidden');
      document.getElementById('question-section').classList.remove('hidden');
      document.getElementById('results-section').classList.add('hidden');

      questions = generateQuestions();
      currentIndex = 0;
      correctCount = 0;
      missedQuestions = [];
      startTime = performance.now();

      showQuestion();
    }

    function showQuestion() {
      if (currentIndex < questions.length) {
        const q = questions[currentIndex];
        document.getElementById('question-text').textContent = `Q${currentIndex + 1}: ${
          q.questionText
        } = ?`;
        const ans = document.getElementById('answer-input');
        ans.value = '';
        ans.focus();
      } else {
        endSession();
      }
    }

    function submitAnswer() {
      if (currentIndex >= questions.length) return;
      const userAns = parseInt(document.getElementById('answer-input').value);
      const q = questions[currentIndex];
      if (userAns === q.correctAnswer) {
        correctCount++;
      } else {
        missedQuestions.push(q);
      }
      currentIndex++;
      showQuestion();
    }

    function skipAnswer() {
      if (currentIndex < questions.length) {
        missedQuestions.push(questions[currentIndex]);
        currentIndex++;
        showQuestion();
      }
    }

    function endSession() {
      document.getElementById('question-section').classList.add('hidden');
      document.getElementById('results-section').classList.remove('hidden');

      const endTime = performance.now();
      const totalTime = (endTime - startTime) / 1000; // in seconds
      const accuracy = correctCount / questions.length;
      const speedFactor = questions.length / totalTime;
      const finalScore = 0.5 * accuracy + 0.5 * speedFactor;

      document.getElementById('correctCount').textContent = correctCount;
      document.getElementById('totalCount').textContent = questions.length;
      document.getElementById('accuracy').textContent = (accuracy * 100).toFixed(2) + '%';
      document.getElementById('timeTaken').textContent = totalTime.toFixed(2);
      document.getElementById('finalScore').textContent = finalScore.toFixed(4);

      // Render tips
      renderTipsForMissed();

      // Leaderboard
      const userOnBoard = updateLeaderboard(finalScore, accuracy, totalTime.toFixed(2));
      if (userOnBoard) {
        const congratsModal = new bootstrap.Modal(document.getElementById('congratsModal'));
        congratsModal.show();
      }
    }

    function renderTipsForMissed() {
      const container = document.getElementById('tips-container');
      container.innerHTML = '';
      if (missedQuestions.length === 0) {
        container.innerHTML = '<p>No missed questions! Well done!</p>';
        return;
      }
      missedQuestions.forEach(q => {
        const tip = getProgrammaticTip(q.operandA, q.operandB, q.operation);
        const div = document.createElement('div');
        div.classList.add('tip-block');
        div.innerHTML = `<strong>${q.questionText} = ${q.correctAnswer}</strong><br/>${tip}`;
        container.appendChild(div);
      });
    }

    /****************************************************************
     * 7) Leaderboard
     ****************************************************************/
    function updateLeaderboard(score, accuracy, timeStr) {
      let lbData = JSON.parse(localStorage.getItem('mathLeaderboard') || '[]');
      const now = new Date();
      const dateStr = [
        now.getFullYear().toString().padStart(4, '0'),
        (now.getMonth() + 1).toString().padStart(2, '0'),
        now.getDate().toString().padStart(2, '0'),
      ].join('');
      const timePart = [
        now.getHours().toString().padStart(2, '0'),
        now.getMinutes().toString().padStart(2, '0'),
        now.getSeconds().toString().padStart(2, '0'),
      ].join(':');

      let randomPantoneName = 'RandomUser';
      if (pantoneData && pantoneData.names && pantoneData.names.length > 0) {
        const idx = Math.floor(getSecureRandomNumber() * pantoneData.names.length);
        randomPantoneName = pantoneData.names[idx];
      }
      const dummyName = `${randomPantoneName}#${dateStr}-${timePart}`;

      const newEntry = {
        username: dummyName,
        score: score,
        accuracy: accuracy,
        time: parseFloat(timeStr),
      };
      lbData.push(newEntry);
      lbData.sort((a, b) => b.score - a.score);
      lbData = lbData.slice(0, 15);

      const userIsInBoard = lbData.some(item => item.username === dummyName);
      localStorage.setItem('mathLeaderboard', JSON.stringify(lbData));
      renderLeaderboard(lbData);
      return userIsInBoard;
    }

    function renderLeaderboard(lbData) {
      const tbody = document.getElementById('leaderboard-body');
      tbody.innerHTML = '';
      lbData.forEach((entry, i) => {
        const tr = document.createElement('tr');
        const rankTd = document.createElement('td');
        rankTd.textContent = i + 1;
        const userTd = document.createElement('td');
        userTd.textContent = entry.username;
        const scoreTd = document.createElement('td');
        scoreTd.textContent = entry.score.toFixed(4);
        const accTd = document.createElement('td');
        accTd.textContent = (entry.accuracy * 100).toFixed(2) + '%';
        const timeTd = document.createElement('td');
        timeTd.textContent = entry.time;
        tr.append(rankTd, userTd, scoreTd, accTd, timeTd);
        tbody.appendChild(tr);
      });
    }

    /****************************************************************
     * 8) Dark Mode
     ****************************************************************/
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkModeMath', isDark);
    }
    function loadDarkModePref() {
      const isDark = localStorage.getItem('darkModeMath') === 'true';
      if (isDark) {
        document.body.classList.add('dark-mode');
      }
    }

    /****************************************************************
     * 9) Event Listeners
     ****************************************************************/
    const startBtn = document.getElementById('startBtn');
    const submitBtn = document.getElementById('submitBtn');
    const skipBtn = document.getElementById('skipBtn');
    const restartBtn = document.getElementById('restartBtn');

    attachColorChange(startBtn);
    attachColorChange(submitBtn);
    attachColorChange(skipBtn);
    attachColorChange(restartBtn);

    startBtn.addEventListener('click', startSession);
    submitBtn.addEventListener('click', submitAnswer);
    skipBtn.addEventListener('click', skipAnswer);
    restartBtn.addEventListener('click', () => {
      document.getElementById('intro-section').classList.remove('hidden');
      document.getElementById('question-section').classList.add('hidden');
      document.getElementById('results-section').classList.add('hidden');
    });

    /****************************************************************
     * 10) On Page Load
     ****************************************************************/
    window.addEventListener('load', async () => {
      loadDarkModePref(); // set dark mode if user had that preference
      await updateBackgroundColor(); // pick an initial Pantone color
    });
  </script>

  <!-- Bootstrap JS (for modals, etc.) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>
