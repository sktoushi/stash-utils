<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allocator</title>
    <script src="config.js"></script>
</head>
<body>
    <h1>Issue Allocator</h1>
    <button onclick="drawRandomIssue()">Draw</button>
    <p id="result"></p>

    <script>
        function drawRandomIssue() {
            const resultElement = document.getElementById('result');
            let totalWeight = 0;
            const ranges = [];

            // Step 1: Process each repo and identify special cases and normal ranges
            config.forEach(item => {
                const { username, repo, startIdx, endIdx } = item;
                const mod = frequencyMods[`${username}-${repo}`] || {};
                let previousEndIdx = startIdx - 1;

                for (const modIdx in mod) {
                    const modIndex = parseInt(modIdx);
                    if (modIndex > previousEndIdx + 1) {
                        // Add the normal range before the special case
                        ranges.push({
                            username,
                            repo,
                            startIdx: previousEndIdx + 1,
                            endIdx: modIndex - 1,
                            weight: modIndex - previousEndIdx - 1
                        });
                        totalWeight += modIndex - previousEndIdx - 1;
                    }
                    // Add the special case
                    ranges.push({
                        username,
                        repo,
                        startIdx: modIndex,
                        endIdx: modIndex,
                        weight: mod[modIdx]
                    });
                    totalWeight += mod[modIdx];
                    previousEndIdx = modIndex;
                }

                if (previousEndIdx < endIdx) {
                    // Add the remaining normal range after the last special case
                    ranges.push({
                        username,
                        repo,
                        startIdx: previousEndIdx + 1,
                        endIdx: endIdx,
                        weight: endIdx - previousEndIdx
                    });
                    totalWeight += endIdx - previousEndIdx;
                }
            });

            // console.log(ranges);
            // console.log(`Total Weight: ${totalWeight}`);

            // Step 2: Pick a random number within the total weighted range
            let randomWeight = Math.floor(Math.random() * totalWeight);
            let cumulativeWeight = 0;

            // Step 3: Determine which range and index the random weight falls into
            for (let range of ranges) {
                cumulativeWeight += range.weight;

                // console.log(`Evaluating Range: ${range.startIdx}-${range.endIdx} | Repo: ${range.username}/${range.repo} | Cumulative Weight: ${cumulativeWeight}`);

                if (randomWeight < cumulativeWeight) {
                    // Calculate the selected index within the current range
                    const rangeSize = range.endIdx - range.startIdx + 1;
                    const withinRangeWeight = randomWeight - (cumulativeWeight - range.weight);
                    const selectedIndex = range.startIdx + (withinRangeWeight % rangeSize);

                    const issueURL = `https://github.com/${range.username}/${range.repo}/issues/${selectedIndex}`;
                    // console.log(`Selected Index: ${selectedIndex} | Repo: ${range.username}/${range.repo} | Issue URL: ${issueURL}`);
                    resultElement.textContent = issueURL;
                    return;
                }
            }
        }
    </script>
</body>
</html>
