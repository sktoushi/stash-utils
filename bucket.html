<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Random URL Picker</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        body.dark-mode {
            background-color: #343a40;
            color: #f8f9fa;
        }
        .container {
            max-width: 900px;
            margin-top: 30px;
        }
        .btn-draw {
            width: 100%;
            margin-bottom: 20px;
        }
        .slider-container, .input-container {
            margin-bottom: 20px;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
        }
        .btn-export {
            margin-top: 10px;
        }
        .gauge-container {
            margin-bottom: 20px;
        }
        .bucket-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .dark-mode .card {
            background-color: #495057;
            color: #f8f9fa;
        }
        .dark-mode .form-control, .dark-mode .form-select {
            background-color: #6c757d;
            color: #f8f9fa;
            border: 1px solid #ced4da;
        }
        .dark-mode .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .dark-mode .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        /* Custom scrollbar for dark mode */
        body.dark-mode ::-webkit-scrollbar {
            width: 8px;
        }
        body.dark-mode ::-webkit-scrollbar-track {
            background: #343a40;
        }
        body.dark-mode ::-webkit-scrollbar-thumb {
            background: #6c757d;
            border-radius: 4px;
        }
    </style>
    <script>
        let currentTargetState = {}; 
        let initialFiles = [];
        let drawHistory = [];
        const historyLimit = 5;
        let lastDrawnId = null;
        let currentTarget = "";
        let localStorageKey = ""; // LocalStorage key based on the target

        /**
         * Function to get a secure random number between 0 (inclusive) and 1 (exclusive).
         */
        function getSecureRandomNumber() {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0] / (0xFFFFFFFF + 1);
        }

        /**
         * Function to shuffle an array in place using Fisher-Yates.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(getSecureRandomNumber() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * Function to parse URL parameters.
         */
        function getUrlParameter(name) {
            name = name.replace(/[]/, '\').replace(/[]/, '\');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        /**
         * Function to fetch JSON data based on target parameter.
         */
        async function fetchInitialFiles(target) {
            try {
                const response = await fetch(`${target}.json`);
                if (!response.ok) {
                    throw new Error(`Unable to fetch ${target}.json`);
                }
                const data = await response.json();
                return data.initialFiles;
            } catch (error) {
                alert(`Error: ${error.message}`);
                return [];
            }
        }

        /**
         * Function to calculate the total frequency of a bucket.
         */
        function getTotalFreq(bucket) {
            return Object.values(bucket).reduce((sum, freq) => sum + freq, 0);
        }

        /**
         * Save the current target's state to localStorage.
         */
        function saveState() {
            localStorage.setItem(localStorageKey, JSON.stringify(currentTargetState));
        }

        /**
         * Load the current target's state from localStorage or bucket-state.json.
         */
        async function loadState() {
            const storedStateString = localStorage.getItem(localStorageKey);
            if (storedStateString) {
                currentTargetState = JSON.parse(storedStateString);
            } else {
                // If not found in localStorage, try bucket-state.json fallback
                try {
                    const response = await fetch('bucket-state.json');
                    if (!response.ok) {
                        throw new Error('Unable to fetch bucket-state.json');
                    }
                    const data = await response.json();
                    // If bucket-state.json has an entry for this target, load it; otherwise, init
                    if (data[currentTarget]) {
                        currentTargetState = { ...data[currentTarget] };
                    } else {
                        initializeTargetState();
                    }
                    // Save to localStorage for future usage
                    saveState();
                } catch (error) {
                    alert('Error loading initial state: ' + error.message);
                    initializeTargetState();
                    saveState();
                }
            }
        }

        /**
         * Initialize the state for the current target.
         * Note the default b1Prob is set to 0.33 (33%).
         */
        function initializeTargetState() {
            currentTargetState = {
                b1: {},
                b2: {},
                uniqueBucket1Count: 0,
                b1Prob: 0.33, // default 33%
                b2Prob: 0.67, // default 67%
                defaultFrequency: 1,
                urlPrefix: '',
                urlSuffix: '',
                drawHistory: []
            };
            initialFiles.forEach(file => {
                const id = file[0];
                const freq = file[2] !== null ? file[2] : currentTargetState.defaultFrequency;
                currentTargetState.b2[id] = freq;
            });
        }

        /**
         * Reset the state for the current target only.
         */
        function resetState() {
            if (!confirm('Are you sure you want to reset the state? This action cannot be undone.')) return;
            // Remove only THIS target's key, preserving others
            localStorage.removeItem(localStorageKey);
            initializeTargetState();
            saveState();
            updateDisplay();
            initializeSlider();
            populateBucketLists();
            populateHistoryList();
            showToast('State has been reset for this target only.');
        }

        /**
         * Export the current target's state to a JSON file.
         */
        function exportState() {
            const stateStr = JSON.stringify(currentTargetState, null, 4);

            // Get current date and time for filename
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-');
            const filename = `bucket-state-${currentTarget}-${timestamp}.json`;

            const blob = new Blob([stateStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            showToast('Current target state exported successfully.');
        }

        /**
         * Import state from a JSON file (overwrites/merges current target’s state).
         */
        function importState() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,application/json';
            fileInput.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const importedState = JSON.parse(event.target.result);
                            // Merge or overwrite currentTargetState
                            currentTargetState = {
                                ...currentTargetState,
                                ...importedState,
                                drawHistory: [
                                    ...(currentTargetState.drawHistory || []),
                                    ...(importedState.drawHistory || [])
                                ].slice(-historyLimit)
                            };
                            saveState();
                            updateDisplay();
                            initializeSlider();
                            populateBucketLists();
                            populateHistoryList();
                            showToast('State has been imported successfully for this target.');
                        } catch (e) {
                            alert('Invalid state data.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            fileInput.click();
        }

        /**
         * Function to update the probabilities based on the slider.
         */
        function updateProbabilities() {
            const sliderValue = parseInt(document.getElementById('probSlider').value);
            currentTargetState.b1Prob = sliderValue / 100;
            currentTargetState.b2Prob = 1 - currentTargetState.b1Prob;
            document.getElementById('probBucket1').innerText = (currentTargetState.b1Prob * 100).toFixed(0) + '%';
            document.getElementById('probBucket2').innerText = (currentTargetState.b2Prob * 100).toFixed(0) + '%';
            saveState();
        }

        /**
         * Function to pick a random URL based on the current state.
         */
        function pickRandom() {
            updateProbabilities(); // Ensure probabilities are up to date

            const rand = getSecureRandomNumber();
            let selectedBucket = rand < currentTargetState.b1Prob ? 'b1' : 'b2';
            let bucket = selectedBucket === 'b1' ? currentTargetState.b1 : currentTargetState.b2;

            if (getTotalFreq(bucket) === 0) {
                bucket = selectedBucket === 'b1' ? currentTargetState.b2 : currentTargetState.b1;
            }

            if (getTotalFreq(bucket) === 0) {
                alert('Both buckets are empty!');
                return;
            }

            const cumulativeFreqs = [];
            let cumulative = 0;
            for (const id in bucket) {
                cumulative += bucket[id];
                cumulativeFreqs.push([parseInt(id), cumulative]);
            }

            const totalFreq = cumulative;
            const randomPick = Math.floor(getSecureRandomNumber() * totalFreq);
            let selectedId;
            for (const [id, cumFreq] of cumulativeFreqs) {
                if (randomPick < cumFreq) {
                    selectedId = id;
                    break;
                }
            }

            const isDuplicate = selectedId in currentTargetState.b1;
            if (isDuplicate) {
                // Duplicate entry drawn; do not change gauges
                currentTargetState.b1[selectedId] += 1;
            } else {
                // Unique entry drawn; update gauges
                currentTargetState.b1[selectedId] = 1;
                currentTargetState.uniqueBucket1Count += 1;
                // Update History
                addToHistory(selectedId);
            }

            if (selectedId in currentTargetState.b2) {
                currentTargetState.b2[selectedId] = Math.max(1, currentTargetState.b2[selectedId] - 1);
                if (currentTargetState.b2[selectedId] === 0) {
                    delete currentTargetState.b2[selectedId];
                }
            }

            lastDrawnId = selectedId;
            saveState();

            const fileDetails = initialFiles.find(file => file[0] === selectedId);
            if (!fileDetails) {
                alert('Selected file not found.');
                return;
            }
            const urlBody = fileDetails[1];

            // Build final URL with prefix/suffix
            let url = urlBody;
            if (currentTargetState.urlPrefix) {
                url = currentTargetState.urlPrefix + url;
            }
            if (currentTargetState.urlSuffix) {
                url = url + currentTargetState.urlSuffix;
            }

            updateDisplay();
            populateBucketLists();
            populateHistoryList();
            window.open(url, '_blank');
            showToast(`Opened URL: ${url}`);
        }

        /**
         * Add a drawn URL to history.
         */
        function addToHistory(id) {
            const fileDetails = initialFiles.find(file => file[0] == id);
            if (fileDetails) {
                const entry = {
                    id: id,
                    url: fileDetails[1],
                    timestamp: new Date().toLocaleString()
                };
                currentTargetState.drawHistory.unshift(entry);
                if (currentTargetState.drawHistory.length > historyLimit) {
                    currentTargetState.drawHistory.pop();
                }
            }
        }

        /**
         * Undo the last draw action.
         */
        function undoLastDraw() {
            if (lastDrawnId === null) {
                alert('No draw action to undo.');
                return;
            }

            if (!(lastDrawnId in currentTargetState.b1)) {
                alert('Invalid state. Cannot undo.');
                return;
            }

            currentTargetState.b1[lastDrawnId] -= 1;
            if (currentTargetState.b1[lastDrawnId] === 0) {
                delete currentTargetState.b1[lastDrawnId];
                currentTargetState.uniqueBucket1Count -= 1;
            }

            if (lastDrawnId in currentTargetState.b2) {
                currentTargetState.b2[lastDrawnId] += 1;
            } else {
                currentTargetState.b2[lastDrawnId] = 1;
            }

            // Remove from history
            currentTargetState.drawHistory.shift();

            lastDrawnId = null;
            saveState();
            updateDisplay();
            populateBucketLists();
            populateHistoryList();
            showToast('Last draw action has been undone.');
        }

        /**
         * Update the display elements.
         */
        function updateDisplay() {
            // Update Review1 Gauge
            const review1Value = ((currentTargetState.uniqueBucket1Count / getInitialB2Total()) * 100).toFixed(2);
            document.getElementById('review1Gauge').value = review1Value;
            document.getElementById('review1Text').innerText = review1Value + '%';

            // Update Review2 Gauge
            const review2Value = (((getInitialB2Total() - currentTargetState.uniqueBucket1Count) / getInitialB2Total()) * 100).toFixed(2);
            document.getElementById('review2Gauge').value = review2Value;
            document.getElementById('review2Text').innerText = review2Value + '%';

            // Update frequencies display
            const b1Total = getTotalFreq(currentTargetState.b1);
            const b2Total = getTotalFreq(currentTargetState.b2);

            document.getElementById('bucket1Freq').innerText = b1Total;
            document.getElementById('bucket2Freq').innerText = b2Total;
        }

        /**
         * Get the initial total frequency of Bucket2 (based on initialFiles).
         */
        function getInitialB2Total() {
            let total = 0;
            initialFiles.forEach(file => {
                const freq = file[2] !== null ? file[2] : currentTargetState.defaultFrequency;
                total += freq;
            });
            return total;
        }

        /**
         * Initialize the probability slider.
         */
        function initializeSlider() {
            const initialSliderValue = (currentTargetState.b1Prob * 100).toFixed(0);
            document.getElementById('probSlider').value = initialSliderValue;
            document.getElementById('probBucket1').innerText = initialSliderValue + '%';
            document.getElementById('probBucket2').innerText = (100 - initialSliderValue) + '%';
        }

        /**
         * Toggle the default frequency input field.
         */
        function toggleDefaultFrequency() {
            const dfInput = document.getElementById('defaultFrequency');
            dfInput.disabled = !dfInput.disabled;
            if (dfInput.disabled) {
                // Revert to stored value
                dfInput.value = currentTargetState.defaultFrequency;
            }
        }

        /**
         * Save the default frequency.
         */
        function saveDefaultFrequency() {
            const dfInput = document.getElementById('defaultFrequency');
            const dfValue = dfInput.value.trim();
            if (dfValue !== '') {
                const df = parseInt(dfValue);
                if (!isNaN(df) && df > 0) {
                    currentTargetState.defaultFrequency = df;
                    // Apply default frequency to items with null or old default
                    initialFiles.forEach(file => {
                        if (file[2] === null || file[2] === currentTargetState.defaultFrequency) {
                            const id = file[0];
                            currentTargetState.b2[id] = currentTargetState.defaultFrequency;
                        }
                    });
                    dfInput.disabled = true;
                    saveState();
                    updateDisplay();
                    populateBucketLists();
                    showToast('Default frequency saved and applied.');
                } else {
                    alert('Please enter a valid positive integer for default frequency.');
                }
            } else {
                alert('Default frequency cannot be empty.');
            }
        }

        /**
         * Save the URL prefix and suffix.
         */
        function saveUrlPrefixSuffix() {
            currentTargetState.urlPrefix = document.getElementById('urlPrefix').value.trim();
            currentTargetState.urlSuffix = document.getElementById('urlSuffix').value.trim();
            saveState();
            showToast('URL prefix and suffix saved.');
        }

        /**
         * Toggle dark mode.
         */
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }

        /**
         * Load dark mode preference.
         */
        function loadDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
            }
        }

        /**
         * Show toast notifications.
         */
        function showToast(message) {
            const toastContainer = document.getElementById('toastContainer');
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-primary border-0';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');

            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;

            toastContainer.appendChild(toastEl);
            const bsToast = new bootstrap.Toast(toastEl);
            bsToast.show();

            toastEl.addEventListener('hidden.bs.toast', () => {
                toastContainer.removeChild(toastEl);
            });
        }

        /**
         * Populate Bucket1 and Bucket2 lists.
         */
        function populateBucketLists() {
            const bucket1List = document.getElementById('bucket1List');
            const bucket2List = document.getElementById('bucket2List');
            bucket1List.innerHTML = '';
            bucket2List.innerHTML = '';

            // Populate Bucket1
            for (const id in currentTargetState.b1) {
                const fileDetails = initialFiles.find(file => file[0] == id);
                if (fileDetails) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<a href="${fileDetails[1]}" target="_blank">${fileDetails[1]}</a> (Freq: ${currentTargetState.b1[id]})`;
                    bucket1List.appendChild(li);
                }
            }

            // Populate Bucket2
            for (const id in currentTargetState.b2) {
                const fileDetails = initialFiles.find(file => file[0] == id);
                if (fileDetails) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<a href="${fileDetails[1]}" target="_blank">${fileDetails[1]}</a> (Freq: ${currentTargetState.b2[id]})`;
                    bucket2List.appendChild(li);
                }
            }
        }

        /**
         * Populate Draw History list.
         */
        function populateHistoryList() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            currentTargetState.drawHistory.forEach(entry => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `<strong>${entry.timestamp}:</strong> <a href="${entry.url}" target="_blank">${entry.url}</a>`;
                historyList.appendChild(li);
            });
        }

        // MODIFIED for dynamic background color with Metro UI palette
        function getRandomColor() {
            // A small set of Metro UI style color codes
            const metroColors = [
                "#2D89EF", // Blue
                "#2B5797", // Darker blue
                "#1E7145", // Green
                "#00ABA9", // Teal
                "#603CBA", // Purple
                "#FFC40D", // Yellow
                "#8CBF26", // Lime
                "#F472D0", // Pink
                "#A200FF", // Magenta
                "#f3ece0",
                "#f2f0eb",
                "#f4f5f0",
                "#f0eee9",
                "#f1e8df",
                "#f0eee4",
                "#e7e9e7",
                "#f2e8da",
                "#ede6db",
                "#e1dbc8",
                "#ddd5c7",
                "#ded7c8",
                "#d7d0c0",
                "#d2cfc4",
                "#f0eada",
                "#f5edd6",
                "#ede3d2",
                "#f5ecd2",
                "#e6ddc5",
                "#dfd1bb",
                "#e6dac4",
                "#f3e0be",
                "#f4efc1",
                "#f0debd",
                "#f4e1c1",
                "#ecddbe",
                "#e7d3ad",
                "#e7d1a1",
                "#e0d5c6",
                "#d0c5b1",
                "#e4d7c5",
                "#d8ccbb",
                "#dccdbc",
                "#dbccb5",
                "#dfd1be",
                "#f6e5db",
                "#eeded1",
                "#f3e0d6",
                "#f0dfcc",
                "#eddcc9",
                "#f3dfca",
                "#efdcc3",
                "#e7dcd9",
                "#f5e3e2",
                "#f2e2e0",
                "#eee2dd",
                "#f6e4d9",
                "#f3dfd7",
                "#e5d9d3",
                "#efefe8",
                "#e2e2da",
                "#dfddd7",
                "#e5ebe3",
                "#e0e4d9",
                "#dde2d6",
                "#dadcd0",
                "#e2eaeb",
                "#e1e3de",
                "#e2e6e0",
                "#d3dedf",
                "#e4eadf",
                "#d8e8e6",
                "#d2d8d2",
                "#dde0df",
                "#d6dbd9",
                "#d3d9d1",
                "#d0d9d4",
                "#cbd7d2",
                "#d8e7e7",
                "#d8e9e5",
                "#e5d0b1",
                "#dfc09f",
                "#ead3ae",
                "#e8d0a7",
                "#f2d6ae",
                "#f5d7af",
                "#dac7ab",
                "#d2cdb4",
                "#d2caaf",
                "#d4cab0",
                "#d2cbaf",
                "#d7cab0",
                "#cbbfa2",
                "#bfaf92",
                "#dad8c9",
                "#d7d7c7",
                "#c1bcac",
                "#c3bdab",
                "#bfb9a3",
                "#b1b09f",
                "#b7b59f",
                "#c8c1ab",
                "#cbc1ae",
                "#c4b6a6",
                "#aea692",
                "#b1a992",
                "#a79b82",
                "#a6997a",
                "#9c8e7b",
                "#9a927f",
                "#918c7e",
                "#938772",
                "#998978",
                "#8a7963",
                "#80765f",
                "#b8a99a",
                "#aea393",
                "#a59788",
                "#9f8d7c",
                "#8d8070",
                "#8e7c71",
                "#827064",
                "#cac2b9",
                "#ad9f93",
                "#9f9586",
                "#a89a8e",
                "#82776b",
                "#776a5f",
                "#696156",
                "#cbc3b4",
                "#cdc6bd",
                "#cfc8bd",
                "#cabeb5",
                "#c5bbae",
                "#b8ad9e",
                "#a89a91",
                "#f4e1e6",
                "#eed4d9",
                "#dcb1af",
                "#ecb2b3",
                "#d18489",
                "#ca848a",
                "#ba797d",
                "#ecd6d6",
                "#e5d0cf",
                "#f9dbd8",
                "#d69fa2",
                "#d1969a",
                "#b35a66",
                "#b45865",
                "#b35457",
                "#ac4b55",
                "#b44e5d",
                "#a73340",
                "#9e1030",
                "#8a2232",
                "#7c2439",
                "#95424e",
                "#973443",
                "#953640",
                "#8c373e",
                "#813639",
                "#782a39",
                "#77212e",
                "#844b4d",
                "#70393f",
                "#884344",
                "#7e3940",
                "#77333b",
                "#702f3b",
                "#5c2c35",
                "#f7d5cc",
                "#e4ccc6",
                "#f5d1c8",
                "#f8cdc9",
                "#f4cec5",
                "#f4c6c3",
                "#e2c1c0",
                "#f6dbd8",
                "#dbbeb7",
                "#d3b4ad",
                "#e2a9a1",
                "#caa39a",
                "#d3a297",
                "#c08a80",
                "#f7c8c2",
                "#eec4be",
                "#ffc4bc",
                "#dfb8b6",
                "#d9a6a1",
                "#d19c97",
                "#ce8e8b",
                "#a75d67",
                "#a4596d",
                "#9f5069",
                "#8c4759",
                "#884c5e",
                "#834655",
                "#7c4c53",
                "#982551",
                "#962d49",
                "#80304c",
                "#842c48",
                "#7a1f3d",
                "#7c2946",
                "#722b3f",
                "#f8d7dd",
                "#fbd3d9",
                "#edd0dd",
                "#e1c6cc",
                "#e6c5ca",
                "#dec6d3",
                "#d8aab7",
                "#f4dede",
                "#e7c9ca",
                "#edd0ce",
                "#f7d1d1",
                "#fdc3c6",
                "#f4c3c4",
                "#fac8c3",
                "#f9c2cd",
                "#f3bbca",
                "#f5bec7",
                "#e6b2b8",
                "#f5b0bd",
                "#ed9ca8",
                "#de98ab",
                "#ce879f",
                "#ce8498",
                "#d294aa",
                "#c28799",
                "#b88995",
                "#b58299",
                "#b0879b",
                "#e9c3cf",
                "#e6bccd",
                "#dba9b8",
                "#e8b5ce",
                "#d9afca",
                "#d8a1c4",
                "#d198c5",
                "#de9bc4",
                "#d28fb0",
                "#d687ba",
                "#ca80b1",
                "#c67fae",
                "#a76c97",
                "#944e87",
                "#c17fb5",
                "#a767a2",
                "#ad5e99",
                "#ba69a1",
                "#a9568c",
                "#864d75",
                "#6b264b",
                "#b65f9a",
                "#ad4d8c",
                "#9e2c6a",
                "#973c6c",
                "#85325c",
                "#802a50",
                "#692746",
                "#a64f82",
                "#993c7c",
                "#92316f",
                "#903f75",
                "#8a3371",
                "#8c3573",
                "#823270",
                "#8d4687",
                "#843e83",
                "#773376",
                "#853b7b",
                "#692d5d",
                "#682961",
                "#622e5a",
                "#d7cbc4",
                "#bdaca3",
                "#bba5a0",
                "#ab9895",
                "#a99592",
                "#ae9490",
                "#ba9f99",
                "#c6a4a4",
                "#ae8c8e",
                "#af9294",
                "#8b6f70",
                "#806062",
                "#80565b",
                "#885157",
                "#957a76",
                "#6c5656",
                "#524144",
                "#5b4349",
                "#5d3c43",
                "#503938",
                "#493338",
                "#c5a193",
                "#9b716b",
                "#6e4c4b",
                "#513235",
                "#60373d",
                "#58363d",
                "#492a34",
                "#663336",
                "#612e35",
                "#64313e",
                "#5c2935",
                "#582b36",
                "#502b33",
                "#532d3b",
                "#c2acb1",
                "#c5aeb1",
                "#c0a5ae",
                "#b598a3",
                "#bfa3af",
                "#ceadbe",
                "#c49bd4",
                "#ad6d7f",
                "#a35776",
                "#996378",
                "#96637b",
                "#8b4963",
                "#854c65",
                "#6f3c56",
                "#c89fa5",
                "#9a7182",
                "#886971",
                "#946c74",
                "#805466",
                "#8d5c74",
                "#895c79",
                "#a4777e",
                "#985f68",
                "#865560",
                "#7a4b56",
                "#804f5a",
                "#643a4c",
                "#5b3644",
                "#674550",
                "#613f4c",
                "#603749",
                "#5c3a4d",
                "#5a2f43",
                "#533146",
                "#462639",
                "#b18eaa",
                "#ae90a7",
                "#9f7a93",
                "#927288",
                "#85677b",
                "#7a596f",
                "#765269",
                "#835e81",
                "#7a547f",
                "#7c5379",
                "#6f456e",
                "#75406a",
                "#683d62",
                "#582147",
                "#725671",
                "#50314c",
                "#5a395b",
                "#4f2d54",
                "#51304e",
                "#553b50",
                "#4d3246",
                "#503b53",
                "#4c3957",
                "#432c47",
                "#473442",
                "#4b3b4f",
                "#4e334e",
                "#3f2a47",
                "#56456b",
                "#493c62",
                "#473951",
                "#433455",
                "#46394b",
                "#41354d",
                "#433748",
                "#dbd2db",
                "#d7cdcd",
                "#d4cacd",
                "#d1c0bf",
                "#b7a9ac",
                "#98868c",
                "#a2919b",
                "#cec3d2",
                "#baafbc",
                "#a5929d",
                "#9d848e",
                "#6c5765",
                "#705861",
                "#54353b",
                "#bdb8c7",
                "#b9b3c5",
                "#9890a2",
                "#948d99",
                "#8f8395",
                "#847986",
                "#75697e",
                "#9d96b2",
                "#a198af",
                "#897f98",
                "#8981a0",
                "#6a6378",
                "#675a74",
                "#473854",
                "#c3babf",
                "#b5acab",
                "#a49ca0",
                "#92898a",
                "#918c8f",
                "#6d636b",
                "#69595c",
                "#e0d0db",
                "#e0c7d7",
                "#d4b9cb",
                "#c0aac0",
                "#bdabbe",
                "#bfb4cb",
                "#bdb0d0",
                "#c5aecf",
                "#d1acce",
                "#be9cc1",
                "#c193c0",
                "#b793c0",
                "#b085b7",
                "#a1759c",
                "#8b79b1",
                "#936ca7",
                "#926aa6",
                "#8b5987",
                "#745587",
                "#764f82",
                "#603f83",
                "#775496",
                "#774d8e",
                "#653d7c",
                "#784384",
                "#6a397b",
                "#663271",
                "#5a315d",
                "#604e7a",
                "#6c4e79",
                "#5a4769",
                "#593761",
                "#542c5d",
                "#482d54",
                "#392852",
                "#d2c4d6",
                "#bca4cb",
                "#afa4ce",
                "#9884b9",
                "#9e91c3",
                "#8f7da5",
                "#807396",
                "#b88aac",
                "#a98baf",
                "#a692ba",
                "#917798",
                "#6b5876",
                "#6c5971",
                "#634f62",
                "#7d74a8",
                "#7e6eac",
                "#6d5698",
                "#5f4b8b",
                "#53357d",
                "#4f3872",
                "#4f3466",
                "#646093",
                "#6d6695",
                "#5a5b9f",
                "#60569a",
                "#544275",
                "#4d448a",
                "#44377d",
                "#646f9b",
                "#62617e",
                "#484a72",
                "#403f6f",
                "#443f6f",
                "#3a395f",
                "#363151",
                "#d0d0da",
                "#bcb4c4",
                "#c5c0d0",
                "#bab8d3",
                "#aaaac4",
                "#a2a1ba",
                "#9c9ba7",
                "#9a9bc1",
                "#919bc9",
                "#848dc5",
                "#7c83bc",
                "#696ba0",
                "#5c619d",
                "#5f6db0",
                "#9499bb",
                "#8c8eb2",
                "#66648b",
                "#47457a",
                "#363b7c",
                "#3d428b",
                "#3d3c7c",
                "#767ba5",
                "#70789b",
                "#60688d",
                "#515b87",
                "#2d3359",
                "#263056",
                "#29304e",
                "#9f99aa",
                "#74809a",
                "#4e5368",
                "#49516d",
                "#4d495b",
                "#464b65",
                "#404466",
                "#bfc7d6",
                "#bbc1cc",
                "#b7c0d6",
                "#959eb7",
                "#618bb9",
                "#6384b8",
                "#5a77a8",
                "#8c9cc1",
                "#858fb1",
                "#8398ca",
                "#81a0d4",
                "#7391c8",
                "#6e81be",
                "#6479b3",
                "#adbed3",
                "#a5b8d0",
                "#93b4d7",
                "#8cadd3",
                "#7a9dcb",
                "#658dc6",
                "#5b7ebd",
                "#7291b4",
                "#65769a",
                "#506886",
                "#4a638d",
                "#3d5e8c",
                "#243f6c",
                "#233658",
                "#6e7e99",
                "#4e5e7f",
                "#505d7e",
                "#3f5277",
                "#384c67",
                "#35465e",
                "#2f3e55",
                "#77acc7",
                "#5d96bc",
                "#5ca6ce",
                "#539ccc",
                "#3e7fa5",
                "#4f7ca4",
                "#2a6a8b",
                "#6da9d2",
                "#6ea2d5",
                "#4d91c6",
                "#5879a2",
                "#43628b",
                "#386192",
                "#385d8d",
                "#7ba0c0",
                "#487ab7",
                "#346cb0",
                "#1f5da0",
                "#195190",
                "#1a4c8b",
                "#0f4c81",
                "#4f84c4",
                "#3272af",
                "#0f5f9a",
                "#08589d",
                "#034f84",
                "#1a5091",
                "#00539c",
                "#3850a0",
                "#4960a8",
                "#384883",
                "#203c7f",
                "#273c76",
                "#1e4477",
                "#313d64",
                "#a5b3cc",
                "#9bb7d4",
                "#96b3d2",
                "#899bb8",
                "#79839b",
                "#717f9b",
                "#7181a4",
                "#c9d3dc",
                "#c0ceda",
                "#b5c7d3",
                "#a3b4c4",
                "#9babbb",
                "#677283",
                "#626879",
                "#b0b7be",
                "#84898c",
                "#46515a",
                "#34414e",
                "#2c313d",
                "#323137",
                "#232f36",
                "#c6d2d2",
                "#98a0a5",
                "#8d8f8f",
                "#4a4b4d",
                "#434854",
                "#3c3f4a",
                "#41424a",
                "#363756",
                "#343148",
                "#353a4c",
                "#2b2e43",
                "#2b3042",
                "#2a3244",
                "#363b48",
                "#a3bdd3",
                "#a0bcd0",
                "#8699ab",
                "#8c9dad",
                "#3c586b",
                "#39505c",
                "#3e4f5c",
                "#8fadbd",
                "#798ea4",
                "#66829a",
                "#59728e",
                "#557088",
                "#516b84",
                "#546477",
                "#5c899b",
                "#5c798e",
                "#5487a4",
                "#5b7e98",
                "#46647e",
                "#405d73",
                "#274357",
                "#b5ced4",
                "#a9c0cb",
                "#9ec1cc",
                "#a2b9c2",
                "#879ba3",
                "#748995",
                "#5c6d7c",
                "#a2b6b9",
                "#9eb6b8",
                "#769da6",
                "#829ca5",
                "#86a1a9",
                "#6d8994",
                "#577284",
                "#9dc3d4",
                "#8abad3",
                "#72a8ba",
                "#5cacce",
                "#4ca5c7",
                "#3cadd4",
                "#52a2b4",
                "#5bacc3",
                "#38afcd",
                "#14a3c7",
                "#289dbe",
                "#3686a0",
                "#157ea0",
                "#1478a7",
                "#4abbd5",
                "#00b1d2",
                "#0088b0",
                "#008db9",
                "#0087b6",
                "#007baa",
                "#0074a8",
                "#008cc1",
                "#0084bd",
                "#007eb1",
                "#0086bb",
                "#007bb2",
                "#0077b3",
                "#0075af",
                "#0072b5",
                "#0075b3",
                "#0061a3",
                "#00589b",
                "#005a92",
                "#266691",
                "#305679",
                "#bcd3d5",
                "#aad5db",
                "#b2d4dd",
                "#a5cfd5",
                "#95c0cb",
                "#a1c8db",
                "#87c2d4",
                "#cbdcdf",
                "#c9dcdc",
                "#c8e0e0",
                "#99c1cc",
                "#76afb6",
                "#6f9fa9",
                "#648589",
                "#ccdad7",
                "#c4d6d3",
                "#bfcdcc",
                "#bcc8c6",
                "#b4c8c2",
                "#99aeae",
                "#89acac",
                "#c6e3e1",
                "#b0d3d1",
                "#9cc2c5",
                "#99c5c4",
                "#87b9bc",
                "#6baaae",
                "#60a0a3",
                "#c3dbd4",
                "#b8e2dc",
                "#c3e9e4",
                "#bce3df",
                "#acdfdd",
                "#9fd9d7",
                "#7bc4c4",
                "#cfdfdb",
                "#a8c0bb",
                "#a3ccc9",
                "#649b9e",
                "#5d9ca4",
                "#4c7e86",
                "#426972",
                "#a5bcbb",
                "#76a7ab",
                "#6d9192",
                "#558f91",
                "#478589",
                "#486b67",
                "#567572",
                "#8a9992",
                "#95a69f",
                "#90a8a4",
                "#658c88",
                "#6a8988",
                "#536d70",
                "#4c6969",
                "#8c9fa1",
                "#8a9a9a",
                "#8f9e9d",
                "#7a898f",
                "#6e8082",
                "#697a7e",
                "#5f7278",
                "#8a9691",
                "#7c8c87",
                "#556962",
                "#576664",
                "#55584c",
                "#464e4d",
                "#303d3c",
                "#3a5c6e",
                "#006380",
                "#1f6680",
                "#005871",
                "#0b5369",
                "#18576c",
                "#1f495b",
                "#4e6e81",
                "#35637c",
                "#3b5f78",
                "#325b74",
                "#09577b",
                "#005e7d",
                "#0f4e67",
                "#006175",
                "#1b5366",
                "#2a5c6a",
                "#1f595c",
                "#33565e",
                "#32575d",
                "#274e55",
                "#64a1ad",
                "#70a4b0",
                "#6198ae",
                "#3c7d90",
                "#47788a",
                "#436573",
                "#2d6471",
                "#00a0b0",
                "#008799",
                "#00859c",
                "#00849f",
                "#00819d",
                "#00758f",
                "#00698b",
                "#83c5cd",
                "#58c9d4",
                "#44bbca",
                "#32becc",
                "#00abc0",
                "#009dae",
                "#007a8e",
                "#67bcb3",
                "#53b0ae",
                "#279d9f",
                "#008c96",
                "#008491",
                "#1a7f8e",
                "#097988",
                "#81d7d3",
                "#00aaa9",
                "#009499",
                "#008786",
                "#008583",
                "#008381",
                "#008684",
                "#45b5aa",
                "#3ab0a2",
                "#4d9e9a",
                "#30a299",
                "#108780",
                "#007c7a",
                "#006d70",
                "#00af9f",
                "#00af9d",
                "#008e80",
                "#009b8c",
                "#009288",
                "#007f7c",
                "#00736c",
                "#73a89e",
                "#619187",
                "#4f7c74",
                "#427d6d",
                "#29685f",
                "#29675c",
                "#035453",
                "#40a48e",
                "#149c88",
                "#007d69",
                "#0a6f69",
                "#226c63",
                "#00675b",
                "#005f56",
                "#6da29e",
                "#599f99",
                "#549f98",
                "#379190",
                "#358082",
                "#20706f",
                "#316c6b",
                "#36716f",
                "#005b5d",
                "#006361",
                "#00656e",
                "#00656b",
                "#00585e",
                "#18454b",
                "#4e6866",
                "#405e5c",
                "#395551",
                "#335959",
                "#255958",
                "#264a48",
                "#203b3d"
            ];
            return metroColors[Math.floor(Math.random() * metroColors.length)];
        }

        /**
         * Main initialization function.
         */
        async function main() {
            loadDarkMode();

            // MODIFIED for dynamic background color
            document.body.style.backgroundColor = getRandomColor();

            // Grab both possible params
            let targetParam = getUrlParameter('target');
            const targetsParam = getUrlParameter('targets');

            // If "targets" param exists, split, shuffle, and pick one value as the target
            if (targetsParam) {
                const arr = targetsParam.split(',');
                shuffleArray(arr);
                targetParam = arr[0];
                console.log('Randomly chosen target from "targets" param:', targetParam);
            }

            // If we still have no target, show an error
            if (!targetParam) {
                alert('Error: neither "target" nor "targets" parameter found in the URL.');
                return;
            }

            currentTarget = targetParam;
            // Build a unique localStorage key
            localStorageKey = 'randomUrlPickerState_' + currentTarget;
            
            // Update the <title> element to the current target
            document.title = currentTarget;

            // Fetch the initialFiles from the corresponding JSON
            initialFiles = await fetchInitialFiles(currentTarget);
            if (initialFiles.length === 0) {
                alert('No files to initialize. Please check your JSON file and parameters.');
                return;
            }

            // Load or init the current target's state
            await loadState();
            updateDisplay();
            initializeSlider();
            populateBucketLists();
            populateHistoryList();

            // Set initial values for inputs
            document.getElementById('defaultFrequency').value = currentTargetState.defaultFrequency;
            document.getElementById('urlPrefix').value = currentTargetState.urlPrefix;
            document.getElementById('urlSuffix').value = currentTargetState.urlSuffix;
            document.getElementById('defaultFrequency').disabled = true;
        }

        window.onload = main;
    </script>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Random URL Picker</h1>

        <!-- Theme Toggle -->
        <div class="text-end mb-3">
            <button class="btn btn-secondary" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                <i class="fas fa-moon"></i> Dark Mode
            </button>
        </div>

        <!-- Help Modal Trigger -->
        <div class="text-end mb-3">
            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#helpModal" title="Help">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>

        <div class="input-container">
            <label class="form-label">URL Prefix:</label>
            <input type="text" class="form-control" id="urlPrefix" placeholder="Enter URL Prefix" title="Add a prefix to all URLs">
            <label class="form-label">URL Suffix:</label>
            <input type="text" class="form-control" id="urlSuffix" placeholder="Enter URL Suffix" title="Add a suffix to all URLs">
            <button class="btn btn-secondary mt-2" onclick="saveUrlPrefixSuffix()" title="Save URL Prefix and Suffix">
                Save URL Prefix/Suffix
            </button>
        </div>

        <div class="input-container">
            <label class="form-label">Default Frequency:</label>
            <div class="input-group">
                <input type="number" class="form-control" id="defaultFrequency" value="1" min="1" disabled title="Set default frequency for new items">
                <button class="btn btn-secondary" onclick="toggleDefaultFrequency()" title="Edit Default Frequency">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-primary" onclick="saveDefaultFrequency()" title="Save Default Frequency">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>

        <div class="slider-container">
            <label for="probSlider" class="form-label">Adjust Probabilities:</label>
            <!-- Default is 33% (Bucket1) / 67% (Bucket2) -->
            <input type="range" class="form-range" id="probSlider" min="0" max="100" value="33" oninput="updateProbabilities()" title="Adjust the probability of selecting from Bucket 1">
            <div class="slider-label">
                <span>Bucket 1: <span id="probBucket1">33%</span></span>
                <span>Bucket 2: <span id="probBucket2">67%</span></span>
            </div>
        </div>

        <button class="btn btn-primary btn-draw" onclick="pickRandom()" title="Draw a random URL">
            <i class="fas fa-random"></i> Draw and Open URL
        </button>

        <button class="btn btn-warning btn-draw" onclick="undoLastDraw()" title="Undo the last draw">
            <i class="fas fa-undo"></i> Undo Last Draw
        </button>

        <!-- Review Gauges -->
        <div class="gauge-container">
            <label for="review1Gauge" class="form-label">Review1 (Unique Bucket1 Items / Initial Bucket2 Total):</label>
            <progress id="review1Gauge" class="form-range w-100" value="0" max="100" aria-label="Review1 Gauge"></progress>
            <div class="text-center">
                <span id="review1Text">0%</span>
            </div>
        </div>

        <div class="gauge-container">
            <label for="review2Gauge" class="form-label">Review2 (Initial Bucket2 Total - Unique Bucket1 Items):</label>
            <progress id="review2Gauge" class="form-range w-100" value="100" max="100" aria-label="Review2 Gauge"></progress>
            <div class="text-center">
                <span id="review2Text">100%</span>
            </div>
        </div>

        <!-- Bucket Lists -->
        <div class="row">
            <div class="col-md-6">
                <h5>Bucket 1 Total Frequency: <span id="bucket1Freq">0</span></h5>
                <ul class="list-group bucket-list" id="bucket1List" aria-label="Bucket 1 Items"></ul>
            </div>
            <div class="col-md-6">
                <h5>Bucket 2 Total Frequency: <span id="bucket2Freq">0</span></h5>
                <ul class="list-group bucket-list" id="bucket2List" aria-label="Bucket 2 Items"></ul>
            </div>
        </div>

        <!-- Draw History -->
        <div class="mt-4">
            <h5>Draw History (Last 5):</h5>
            <ul class="list-group history-list" id="historyList" aria-label="Draw History"></ul>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-4">
            <button class="btn btn-secondary btn-export" onclick="exportState()" title="Export current target state as JSON">
                <i class="fas fa-file-export"></i> Export State
            </button>
            <button class="btn btn-secondary btn-export" onclick="importState()" title="Import state for this target from a JSON file">
                <i class="fas fa-file-import"></i> Import State
            </button>
            <button class="btn btn-danger btn-export" onclick="resetState()" title="Reset this target's settings and state">
                <i class="fas fa-trash-alt"></i> Reset State
            </button>
        </div>

        <!-- Toast Container -->
        <div aria-live="polite" aria-atomic="true" class="position-relative">
            <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                <!-- Toasts will be appended here -->
            </div>
        </div>

        <!-- Help Modal -->
        <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="helpModalLabel">Help & Instructions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Overview</h6>
                        <p>This application allows you to randomly select URLs from a predefined list with customizable settings.</p>
                        <h6>Features</h6>
                        <ul>
                            <li><strong>URL Prefix/Suffix:</strong> Add prefixes or suffixes to all URLs before they are opened.</li>
                            <li><strong>Default Frequency:</strong> Set the default frequency for new items.</li>
                            <li><strong>Adjust Probabilities:</strong> Control the likelihood of selecting from Bucket1 or Bucket2.</li>
                            <li><strong>Draw History:</strong> View a log of the last 5 drawn URLs.</li>
                            <li><strong>Undo Last Draw:</strong> Revert the last draw action.</li>
                            <li><strong>Import/Export State:</strong> Save and load your current state using JSON files (per target).</li>
                            <li><strong>Dark Mode:</strong> Toggle between light and dark themes for better visibility.</li>
                        </ul>
                        <h6>How to Use</h6>
                        <ol>
                            <li><strong>Set URL Prefix/Suffix</strong>: Enter any prefix or suffix you want to add to the URLs and click "Save URL Prefix/Suffix".</li>
                            <li><strong>Set Default Frequency</strong>: Click the "Edit" button next to "Default Frequency", enter a positive integer, and click "Save".</li>
                            <li><strong>Adjust Probabilities</strong>: Use the slider to set the probability of selecting from Bucket1 and Bucket2.</li>
                            <li><strong>Draw URL</strong>: Click "Draw and Open URL" to randomly select and open a URL based on the current settings.</li>
                            <li><strong>Undo Draw</strong>: If you accidentally draw a URL, click "Undo Last Draw" to revert the last action.</li>
                            <li><strong>View Buckets</strong>: Check the lists under Bucket1 and Bucket2 to see current items and their frequencies.</li>
                            <li><strong>View Draw History</strong>: Scroll through the "Draw History" section to see the last 5 drawn URLs.</li>
                            <li><strong>Import/Export State</strong>: Use the respective buttons to save your current state or load a previously saved state for this target.</li>
                            <li><strong>Toggle Dark Mode</strong>: Click the "Dark Mode" button at the top-right to switch themes.</li>
                            <li><strong>Reset State</strong>: Click "Reset State" to clear all settings and start fresh for this target only.</li>
                        </ol>
                        <h6>Notes</h6>
                        <ul>
                            <li>Use the <code>target</code> parameter (<em>e.g.</em>, <code>?target=foo</code>) or <code>targets</code> parameter (<em>e.g.</em>, <code>?targets=foo,bar,baz</code>) to define which JSON file(s) to randomly pick from.</li>
                            <li>Imported states overwrite/merge only for the current target, preserving others in localStorage.</li>
                            <li>Toast notifications will appear at the bottom-right corner for various actions.</li>
                            <li>Check or create the <code>bucket-state.json</code> if you’d like a fallback initial state for multiple targets.</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS and dependencies -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" 
                integrity="sha384-wpsYrgENSMwvWDnK+0hqyc+8zhu+uZdzsOCS8KQmS1b2y2lZjY0Chvh6e+GD44G" 
                crossorigin="anonymous"></script>
    </div>
</body>
</html>
