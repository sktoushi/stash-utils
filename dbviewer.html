<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Random DB Viewer</title>

  <!-- GitHub-ish Dark Mode Styles -->
  <style>
    :root {
      --bg:       #0d1117;
      --panel:    #161b22;
      --border:   #30363d;
      --text:     #c9d1d9;
      --text-sub: #8b949e;
      --accent:   #238636;
      --btn-bg:   #21262d;
      --btn-hover:#30363d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 1.1rem;
    }
    main {
      flex: 1;
      width: 100%;
      max-width: 760px;
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .issue-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1.5rem;
      overflow-x: auto;
      word-break: break-word;
    }
    .issue-id {
      font-weight: 600;
      color: var(--accent);
    }
    .issue-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    .issue-table th,
    .issue-table td {
      padding: 0.35rem 0.6rem;
      border: 1px solid var(--border);
    }
    .issue-table th {
      background: #1e242c;
      text-align: left;
      color: var(--text-sub);
      font-weight: 500;
    }
    button {
      align-self: flex-start;
      padding: 0.55rem 1rem;
      color: var(--text);
      background: var(--btn-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.15s;
    }
    button:hover { background: var(--btn-hover); }
    footer {
      text-align: center;
      padding: 1rem 0 2rem;
      font-size: 0.8rem;
      color: var(--text-sub);
      border-top: 1px solid var(--border);
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>

  <!-- sql.js (WASM) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/sql-wasm.js"></script>
</head>
<body>
  <header>ðŸ“š Random DB Viewer</header>

  <main>
    <button id="newEntryBtn" disabled>ðŸ”„ Draw Another Random Entry</button>
    <article id="issueContainer" class="issue-card">
      <p>Loading database â€¦</p>
    </article>
  </main>

  <footer>
    Powered by <a href="https://github.com/sql-js/sql.js" target="_blank" rel="noopener">sql.js</a>
  </footer>

  <script>
    (async function () {
      /*******************
       * 1) URL Helpers  *
       *******************/
      const params   = new URLSearchParams(location.search);
      const dbFile   = params.get('db') || 'memo_20250607-1.db';   // default file
      const tableParam = params.get('table'); // optional override of table name

      // DOM elements
      const issueContainer = document.getElementById('issueContainer');
      const newEntryBtn    = document.getElementById('newEntryBtn');

      /***********************
       * 2) Load sql.js WASM *
       ***********************/
      const SQL = await initSqlJs({
        locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/${f}`
      });

      /********************************
       * 3) Fetch & open the database *
       ********************************/
      let db;
      try {
        const response   = await fetch(dbFile, { cache: 'no-store' });
        if (!response.ok) throw new Error(`Network error: ${response.status} ${response.statusText}`);
        const buf        = await response.arrayBuffer();
        db               = new SQL.Database(new Uint8Array(buf));
      } catch (err) {
        issueContainer.innerHTML = `<p style="color:#f85149"><strong>Error loading DB:</strong> ${err.message}</p>`;
        console.error(err);
        return;
      }

      /****************************
       * 4) Determine table name  *
       ****************************/
      let tableName = tableParam;
      if (!tableName) {
        try {
          const tables = db.exec(`SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';`);
          if (!tables.length) throw new Error('No user tables found in DB.');
          tableName = tables[0].values[0][0];
        } catch (e) {
          issueContainer.innerHTML = `<p style="color:#f85149"><strong>Error:</strong> ${e.message}</p>`;
          console.error(e);
          return;
        }
      }

      // Enable the button now that DB is ready
      newEntryBtn.disabled = false;
      newEntryBtn.addEventListener('click', renderRandomRow);

      /*****************************
       * 5) Render a random entry  *
       *****************************/
      function renderRandomRow () {
        let row;
        try {
          const result = db.exec(`SELECT * FROM "${tableName}" ORDER BY RANDOM() LIMIT 1;`);
          if (!result.length || !result[0].values.length) {
            issueContainer.innerHTML = '<p>No data found in this table.</p>';
            return;
          }
          row = result[0];
        } catch (e) {
          issueContainer.innerHTML = `<p style="color:#f85149"><strong>Query failed:</strong> ${e.message}</p>`;
          console.error(e);
          return;
        }

        const cols = row.columns;
        const vals = row.values[0];

        // Build HTML table
        let html  = `<div class="issue-id">#${vals[0]}</div>`;
        html     += '<table class="issue-table"><thead><tr>';
        cols.forEach(col => { html += `<th>${col}</th>`; });
        html     += '</tr></thead><tbody><tr>';
        vals.forEach(val => { html += `<td>${escapeHtml(String(val))}</td>`; });
        html     += '</tr></tbody></table>';

        issueContainer.innerHTML = html;
      }

      // Helper for escaping HTML
      function escapeHtml (unsafe) {
        return unsafe
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // Initial draw
      renderRandomRow();
    })();
  </script>
</body>
</html>
