<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Random DB Viewer</title>

  <!-- --- GitHub-dark-mode look & feel --- -->
  <style>
    :root{
      --bg:#0d1117;--panel:#161b22;--border:#30363d;--text:#c9d1d9;
      --text-sub:#8b949e;--accent:#238636;--btn:#21262d;--btn-hov:#30363d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      line-height:1.5;display:flex;flex-direction:column;min-height:100vh;
    }
    header{padding:1rem 2rem;border-bottom:1px solid var(--border);font-weight:600;font-size:1.1rem}
    main{flex:1;max-width:760px;width:100%;margin:2rem auto;display:flex;flex-direction:column;gap:1.5rem}
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:6px;
      padding:1.5rem;overflow-x:auto;word-break:break-word
    }
    .row-id{font-weight:600;color:var(--accent);margin-bottom:0.25rem}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{padding:.35rem .6rem;border:1px solid var(--border)}
    th{background:#1e242c;color:var(--text-sub);font-weight:500;text-align:left}
    button{
      align-self:flex-start;padding:.55rem 1rem;font-size:.95rem;cursor:pointer;
      background:var(--btn);border:1px solid var(--border);border-radius:6px;color:var(--text);
      transition:background .15s
    }
    button:hover{background:var(--btn-hov)}
    footer{text-align:center;padding:1rem 0 2rem;font-size:.8rem;color:var(--text-sub);border-top:1px solid var(--border)}
    a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
  </style>

  <!-- sql.js (WebAssembly) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/sql-wasm.js"></script>
</head>
<body>
<header>ðŸ“š Random DB Viewer</header>

<main>
  <button id="drawBtn" disabled>ðŸ”„ Draw Another Random Entry</button>
  <article id="card" class="card"><p>Loading databaseâ€¦</p></article>
</main>

<footer>Powered by <a href="https://github.com/sql-js/sql.js" target="_blank" rel="noopener">sql.js</a></footer>

<script>
(async function () {
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ URL params â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const params      = new URLSearchParams(location.search);
  const dbFile      = params.get('db')    || 'memo_20250607-1.db';
  const forcedTable = params.get('table');            // optional ?table=name

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const card   = document.getElementById('card');
  const btn    = document.getElementById('drawBtn');

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Load sql.js WASM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const SQL = await initSqlJs({
    locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/${f}`
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fetch DB file â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let db;
  try{
    const res = await fetch(dbFile,{cache:'no-store'});
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const buf = await res.arrayBuffer();
    db        = new SQL.Database(new Uint8Array(buf));
  }catch(e){
    card.innerHTML = `<p style="color:#f85149"><strong>Error loading DB:</strong> ${e.message}</p>`;
    console.error(e); return;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Decide which table to use â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let table = forcedTable;
  if(!table){
    const tRes = db.exec(`SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';`);
    if(!tRes.length){
      card.innerHTML='<p>No user tables found.</p>'; return;
    }
    const names = tRes[0].values.map(v=>v[0]);
    // choose the table with the largest row-count
    let best   = names[0], bestCnt = -1;
    for(const n of names){
      try{
        const cnt = db.exec(`SELECT COUNT(*) AS c FROM "${n}";`)[0].values[0][0];
        if(cnt > bestCnt){bestCnt = cnt; best = n;}
      }catch(e){console.warn('Count failed for table',n,e)}
    }
    table = best;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Helper: render one random row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const escapeHtml = s => s
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

  function drawRandom(){
    let rowSet;
    try{
      rowSet = db.exec(`SELECT * FROM "${table}" ORDER BY RANDOM() LIMIT 1;`);
      if(!rowSet.length || !rowSet[0].values.length){
        card.innerHTML='<p>No rows in this table.</p>';return;
      }
    }catch(e){
      card.innerHTML = `<p style="color:#f85149"><strong>Query error:</strong> ${e.message}</p>`;
      console.error(e); return;
    }
    const cols = rowSet[0].columns, vals = rowSet[0].values[0];

    /* build HTML */
    let html  = '';
    const idIndex = cols.findIndex(c=>/id$/i.test(c));
    const idVal   = idIndex!==-1? vals[idIndex]: vals[0];
    html += `<div class="row-id">#${escapeHtml(String(idVal))}</div>`;
    html += '<table><thead><tr>';
    cols.forEach(c=>html+=`<th>${escapeHtml(c)}</th>`); html+='</tr></thead><tbody><tr>';
    vals.forEach(v=>html+=`<td>${escapeHtml(String(v))}</td>`); html+='</tr></tbody></table>';
    card.innerHTML = html;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Wire up button & initial render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  btn.disabled = false;
  btn.addEventListener('click', drawRandom);
  drawRandom();                      // initial row on page-load

})();
</script>
</body>
</html>
